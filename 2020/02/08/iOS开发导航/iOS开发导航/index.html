<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />










  <meta name="baidu-site-verification" content="zASw3GjPZA" />







  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="iOS开发导航html {overflow-x: initial !important;}:root { --bg-color: #ffffff; --text-color: #333333; --select-text-bg-color: #B5D6FC; --select-text-font-color: auto; --monospace: &quot;Lucida Console&quot;,Cons">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS开发导航&#x2F;iOS开发导航">
<meta property="og:url" content="http://yoursite.com/2020/02/08/iOS%E5%BC%80%E5%8F%91%E5%AF%BC%E8%88%AA/iOS%E5%BC%80%E5%8F%91%E5%AF%BC%E8%88%AA/index.html">
<meta property="og:site_name" content="曾维俊的博客">
<meta property="og:description" content="iOS开发导航html {overflow-x: initial !important;}:root { --bg-color: #ffffff; --text-color: #333333; --select-text-bg-color: #B5D6FC; --select-text-font-color: auto; --monospace: &quot;Lucida Console&quot;,Cons">
<meta property="og:image" content="http://yoursite.com/2020/02/08/iOS%E5%BC%80%E5%8F%91%E5%AF%BC%E8%88%AA/iOS%E5%BC%80%E5%8F%91%E5%AF%BC%E8%88%AA/images/retain_cycle.png">
<meta property="og:image" content="http://yoursite.com/2020/02/08/iOS%E5%BC%80%E5%8F%91%E5%AF%BC%E8%88%AA/iOS%E5%BC%80%E5%8F%91%E5%AF%BC%E8%88%AA/images/lock_benchmark.png">
<meta property="og:image" content="http://yoursite.com/2020/02/08/iOS%E5%BC%80%E5%8F%91%E5%AF%BC%E8%88%AA/iOS%E5%BC%80%E5%8F%91%E5%AF%BC%E8%88%AA/images/uikit-framework.jpg">
<meta property="og:image" content="http://yoursite.com/2020/02/08/iOS%E5%BC%80%E5%8F%91%E5%AF%BC%E8%88%AA/iOS%E5%BC%80%E5%8F%91%E5%AF%BC%E8%88%AA/images/cornerRadius.png">
<meta property="og:image" content="http://yoursite.com/2020/02/08/iOS%E5%BC%80%E5%8F%91%E5%AF%BC%E8%88%AA/iOS%E5%BC%80%E5%8F%91%E5%AF%BC%E8%88%AA/images/coregraphics1.png">
<meta property="og:image" content="http://yoursite.com/2020/02/08/iOS%E5%BC%80%E5%8F%91%E5%AF%BC%E8%88%AA/iOS%E5%BC%80%E5%8F%91%E5%AF%BC%E8%88%AA/images/coregraphics2.png">
<meta property="article:published_time" content="2020-02-08T07:01:19.732Z">
<meta property="article:modified_time" content="2020-02-08T07:01:19.733Z">
<meta property="article:author" content="nius">
<meta property="article:tag" content="iOS">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/2020/02/08/iOS%E5%BC%80%E5%8F%91%E5%AF%BC%E8%88%AA/iOS%E5%BC%80%E5%8F%91%E5%AF%BC%E8%88%AA/images/retain_cycle.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/02/08/iOS开发导航/iOS开发导航/"/>





  <title>iOS开发导航/iOS开发导航 | 曾维俊的博客</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?68377c9fdac56535e2b9ff551a9b9d8b";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">曾维俊的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">路漫漫其修远兮，吾将上下而求索！</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/08/iOS%E5%BC%80%E5%8F%91%E5%AF%BC%E8%88%AA/iOS%E5%BC%80%E5%8F%91%E5%AF%BC%E8%88%AA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="nius">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="曾维俊的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">iOS开发导航/iOS开发导航</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-02-08T15:01:19+08:00">
                2020-02-08
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/02/08/iOS%E5%BC%80%E5%8F%91%E5%AF%BC%E8%88%AA/iOS%E5%BC%80%E5%8F%91%E5%AF%BC%E8%88%AA/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2020/02/08/iOS%E5%BC%80%E5%8F%91%E5%AF%BC%E8%88%AA/iOS%E5%BC%80%E5%8F%91%E5%AF%BC%E8%88%AA/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>
<title>iOS开发导航</title><link href='https://fonts.loli.net/css?family=Open+Sans:400italic,700italic,700,400&subset=latin,latin-ext' rel='stylesheet' type='text/css' /><style type='text/css'>html {overflow-x: initial !important;}:root { --bg-color: #ffffff; --text-color: #333333; --select-text-bg-color: #B5D6FC; --select-text-font-color: auto; --monospace: "Lucida Console",Consolas,"Courier",monospace; }
html { font-size: 14px; background-color: var(--bg-color); color: var(--text-color); font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; -webkit-font-smoothing: antialiased; }
body { margin: 0px; padding: 0px; height: auto; bottom: 0px; top: 0px; left: 0px; right: 0px; font-size: 1rem; line-height: 1.42857143; overflow-x: hidden; background-image: inherit; background-size: inherit; background-attachment: inherit; background-origin: inherit; background-clip: inherit; background-color: inherit; tab-size: 4; background-position: inherit inherit; background-repeat: inherit inherit; }
iframe { margin: auto; }
a.url { word-break: break-all; }
a:active, a:hover { outline: 0px; }
.in-text-selection, ::selection { text-shadow: none; background: var(--select-text-bg-color); color: var(--select-text-font-color); }
#write { margin: 0px auto; height: auto; width: inherit; word-break: normal; word-wrap: break-word; position: relative; white-space: normal; overflow-x: visible; padding-top: 40px; }
#write.first-line-indent p { text-indent: 2em; }
#write.first-line-indent li p, #write.first-line-indent p * { text-indent: 0px; }
#write.first-line-indent li { margin-left: 2em; }
.for-image #write { padding-left: 8px; padding-right: 8px; }
body.typora-export { padding-left: 30px; padding-right: 30px; }
.typora-export .footnote-line, .typora-export li, .typora-export p { white-space: pre-wrap; }
@media screen and (max-width: 500px) { 
  body.typora-export { padding-left: 0px; padding-right: 0px; }
  #write { padding-left: 20px; padding-right: 20px; }
  .CodeMirror-sizer { margin-left: 0px !important; }
  .CodeMirror-gutters { display: none !important; }
}
#write li > figure:last-child { margin-bottom: 0.5rem; }
#write ol, #write ul { position: relative; }
img { max-width: 100%; vertical-align: middle; }
button, input, select, textarea { color: inherit; font-family: inherit; font-size: inherit; font-style: inherit; font-variant-caps: inherit; font-weight: inherit; font-stretch: inherit; line-height: inherit; }
input[type="checkbox"], input[type="radio"] { line-height: normal; padding: 0px; }
*, ::after, ::before { box-sizing: border-box; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p, #write pre { width: inherit; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p { position: relative; }
p { line-height: inherit; }
h1, h2, h3, h4, h5, h6 { break-after: avoid-page; break-inside: avoid; orphans: 2; }
p { orphans: 4; }
h1 { font-size: 2rem; }
h2 { font-size: 1.8rem; }
h3 { font-size: 1.6rem; }
h4 { font-size: 1.4rem; }
h5 { font-size: 1.2rem; }
h6 { font-size: 1rem; }
.md-math-block, .md-rawblock, h1, h2, h3, h4, h5, h6, p { margin-top: 1rem; margin-bottom: 1rem; }
.hidden { display: none; }
.md-blockmeta { color: rgb(204, 204, 204); font-weight: 700; font-style: italic; }
a { cursor: pointer; }
sup.md-footnote { padding: 2px 4px; background-color: rgba(238, 238, 238, 0.701961); color: rgb(85, 85, 85); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; cursor: pointer; }
sup.md-footnote a, sup.md-footnote a:hover { color: inherit; text-transform: inherit; text-decoration: inherit; }
#write input[type="checkbox"] { cursor: pointer; width: inherit; height: inherit; }
figure { overflow-x: auto; margin: 1.2em 0px; max-width: calc(100% + 16px); padding: 0px; }
figure > table { margin: 0px !important; }
tr { break-inside: avoid; break-after: auto; }
thead { display: table-header-group; }
table { border-collapse: collapse; border-spacing: 0px; width: 100%; overflow: auto; break-inside: auto; text-align: left; }
table.md-table td { min-width: 32px; }
.CodeMirror-gutters { border-right-width: 0px; background-color: inherit; }
.CodeMirror-linenumber { }
.CodeMirror { text-align: left; }
.CodeMirror-placeholder { opacity: 0.3; }
.CodeMirror pre { padding: 0px 4px; }
.CodeMirror-lines { padding: 0px; }
div.hr:focus { cursor: none; }
#write pre { white-space: pre-wrap; }
#write.fences-no-line-wrapping pre { white-space: pre; }
#write pre.ty-contain-cm { white-space: normal; }
.CodeMirror-gutters { margin-right: 4px; }
.md-fences { font-size: 0.9rem; display: block; break-inside: avoid; text-align: left; overflow: visible; white-space: pre; background-image: inherit; background-size: inherit; background-attachment: inherit; background-origin: inherit; background-clip: inherit; background-color: inherit; position: relative !important; background-position: inherit inherit; background-repeat: inherit inherit; }
.md-diagram-panel { width: 100%; margin-top: 10px; text-align: center; padding-top: 0px; padding-bottom: 8px; overflow-x: auto; }
#write .md-fences.mock-cm { white-space: pre-wrap; }
.md-fences.md-fences-with-lineno { padding-left: 0px; }
#write.fences-no-line-wrapping .md-fences.mock-cm { white-space: pre; overflow-x: auto; }
.md-fences.mock-cm.md-fences-with-lineno { padding-left: 8px; }
.CodeMirror-line, twitterwidget { break-inside: avoid; }
.footnotes { opacity: 0.8; font-size: 0.9rem; margin-top: 1em; margin-bottom: 1em; }
.footnotes + .footnotes { margin-top: 0px; }
.md-reset { margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: top; text-decoration: none; text-shadow: none; float: none; position: static; width: auto; height: auto; white-space: nowrap; cursor: inherit; line-height: normal; font-weight: 400; text-align: left; box-sizing: content-box; direction: ltr; background-position: 0px 0px; background-repeat: initial initial; }
li div { padding-top: 0px; }
blockquote { margin: 1rem 0px; }
li .mathjax-block, li p { margin: 0.5rem 0px; }
li { margin: 0px; position: relative; }
blockquote > :last-child { margin-bottom: 0px; }
blockquote > :first-child, li > :first-child { margin-top: 0px; }
.footnotes-area { color: rgb(136, 136, 136); margin-top: 0.714rem; padding-bottom: 0.143rem; white-space: normal; }
#write .footnote-line { white-space: pre-wrap; }
@media print { 
  body, html { border: 1px solid transparent; height: 99%; break-after: avoid; break-before: avoid; }
  #write { margin-top: 0px; padding-top: 0px; border-color: transparent !important; }
  .typora-export * { -webkit-print-color-adjust: exact; }
  html.blink-to-pdf { font-size: 13px; }
  .typora-export #write { padding-left: 32px; padding-right: 32px; padding-bottom: 0px; break-after: avoid; }
  .typora-export #write::after { height: 0px; }
}
.footnote-line { margin-top: 0.714em; font-size: 0.7em; }
a img, img a { cursor: pointer; }
pre.md-meta-block { font-size: 0.8rem; min-height: 0.8rem; white-space: pre-wrap; background-color: rgb(204, 204, 204); display: block; overflow-x: hidden; background-position: initial initial; background-repeat: initial initial; }
p > .md-image:only-child:not(.md-img-error) img, p > img:only-child { display: block; margin: auto; }
p > .md-image:only-child { display: inline-block; width: 100%; }
#write .MathJax_Display { margin: 0.8em 0px 0px; }
.md-math-block { width: 100%; }
.md-math-block:not(:empty)::after { display: none; }
[contenteditable="true"]:active, [contenteditable="true"]:focus { outline: 0px; box-shadow: none; }
.md-task-list-item { position: relative; list-style-type: none; }
.task-list-item.md-task-list-item { padding-left: 0px; }
.md-task-list-item > input { position: absolute; top: 0px; left: 0px; margin-left: -1.2em; margin-top: calc(1em - 10px); border: none; }
.math { font-size: 1rem; }
.md-toc { min-height: 3.58rem; position: relative; font-size: 0.9rem; border-top-left-radius: 10px; border-top-right-radius: 10px; border-bottom-right-radius: 10px; border-bottom-left-radius: 10px; }
.md-toc-content { position: relative; margin-left: 0px; }
.md-toc-content::after, .md-toc::after { display: none; }
.md-toc-item { display: block; color: rgb(65, 131, 196); }
.md-toc-item a { text-decoration: none; }
.md-toc-inner:hover { text-decoration: underline; }
.md-toc-inner { display: inline-block; cursor: pointer; }
.md-toc-h1 .md-toc-inner { margin-left: 0px; font-weight: 700; }
.md-toc-h2 .md-toc-inner { margin-left: 2em; }
.md-toc-h3 .md-toc-inner { margin-left: 4em; }
.md-toc-h4 .md-toc-inner { margin-left: 6em; }
.md-toc-h5 .md-toc-inner { margin-left: 8em; }
.md-toc-h6 .md-toc-inner { margin-left: 10em; }
@media screen and (max-width: 48em) { 
  .md-toc-h3 .md-toc-inner { margin-left: 3.5em; }
  .md-toc-h4 .md-toc-inner { margin-left: 5em; }
  .md-toc-h5 .md-toc-inner { margin-left: 6.5em; }
  .md-toc-h6 .md-toc-inner { margin-left: 8em; }
}
a.md-toc-inner { font-size: inherit; font-style: inherit; font-weight: inherit; line-height: inherit; }
.footnote-line a:not(.reversefootnote) { color: inherit; }
.md-attr { display: none; }
.md-fn-count::after { content: "."; }
code, pre, samp, tt { font-family: var(--monospace); }
kbd { margin: 0px 0.1em; padding: 0.1em 0.6em; font-size: 0.8em; color: rgb(36, 39, 41); background-color: rgb(255, 255, 255); border: 1px solid rgb(173, 179, 185); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; box-shadow: rgba(12, 13, 14, 0.2) 0px 1px 0px, rgb(255, 255, 255) 0px 0px 0px 2px inset; white-space: nowrap; vertical-align: middle; background-position: initial initial; background-repeat: initial initial; }
.md-comment { color: rgb(162, 127, 3); opacity: 0.8; font-family: var(--monospace); }
code { text-align: left; }
a.md-print-anchor { white-space: pre !important; border: none !important; display: inline-block !important; position: absolute !important; width: 1px !important; right: 0px !important; outline: 0px !important; text-shadow: initial !important; background-position: 0px 0px !important; background-repeat: initial initial !important; }
.md-inline-math .MathJax_SVG .noError { display: none !important; }
.html-for-mac .inline-math-svg .MathJax_SVG { vertical-align: 0.2px; }
.md-math-block .MathJax_SVG_Display { text-align: center; margin: 0px; position: relative; text-indent: 0px; max-width: none; max-height: none; min-height: 0px; min-width: 100%; width: auto; overflow-y: hidden; display: block !important; }
.MathJax_SVG_Display, .md-inline-math .MathJax_SVG_Display { width: auto; margin: inherit; display: inline-block !important; }
.MathJax_SVG .MJX-monospace { font-family: var(--monospace); }
.MathJax_SVG .MJX-sans-serif { font-family: sans-serif; }
.MathJax_SVG { display: inline; font-style: normal; font-weight: 400; line-height: normal; zoom: 90%; text-indent: 0px; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0px; min-height: 0px; border: 0px; padding: 0px; margin: 0px; }
.MathJax_SVG * { transition: none; }
.MathJax_SVG_Display svg { vertical-align: middle !important; margin-bottom: 0px !important; margin-top: 0px !important; }
.os-windows.monocolor-emoji .md-emoji { font-family: "Segoe UI Symbol", sans-serif; }
.md-diagram-panel > svg { max-width: 100%; }
[lang="mermaid"] svg, [lang="flow"] svg { max-width: 100%; height: auto; }
[lang="mermaid"] .node text { font-size: 1rem; }
table tr th { border-bottom-width: 0px; }
video { max-width: 100%; display: block; margin: 0px auto; }
iframe { max-width: 100%; width: 100%; border: none; }
.highlight td, .highlight tr { border: 0px; }
svg[id^="mermaidChart"] { line-height: 1em; }
mark { background-color: rgb(255, 255, 0); color: rgb(0, 0, 0); background-position: initial initial; background-repeat: initial initial; }
.md-html-inline .md-plain, .md-html-inline strong, mark .md-inline-math, mark strong { color: inherit; }
mark .md-meta { color: rgb(0, 0, 0); opacity: 0.3 !important; }


.CodeMirror { height: auto; }
.CodeMirror.cm-s-inner { background-image: inherit; background-size: inherit; background-attachment: inherit; background-origin: inherit; background-clip: inherit; background-color: inherit; background-position: inherit inherit; background-repeat: inherit inherit; }
.CodeMirror-scroll { overflow-y: hidden; overflow-x: auto; z-index: 3; }
.CodeMirror-gutter-filler, .CodeMirror-scrollbar-filler { background-color: rgb(255, 255, 255); }
.CodeMirror-gutters { border-right-width: 1px; border-right-style: solid; border-right-color: rgb(221, 221, 221); background-image: inherit; background-size: inherit; background-attachment: inherit; background-origin: inherit; background-clip: inherit; background-color: inherit; white-space: nowrap; background-position: inherit inherit; background-repeat: inherit inherit; }
.CodeMirror-linenumber { padding: 0px 3px 0px 5px; text-align: right; color: rgb(153, 153, 153); }
.cm-s-inner .cm-keyword { color: rgb(119, 0, 136); }
.cm-s-inner .cm-atom, .cm-s-inner.cm-atom { color: rgb(34, 17, 153); }
.cm-s-inner .cm-number { color: rgb(17, 102, 68); }
.cm-s-inner .cm-def { color: rgb(0, 0, 255); }
.cm-s-inner .cm-variable { color: rgb(0, 0, 0); }
.cm-s-inner .cm-variable-2 { color: rgb(0, 85, 170); }
.cm-s-inner .cm-variable-3 { color: rgb(0, 136, 85); }
.cm-s-inner .cm-string { color: rgb(170, 17, 17); }
.cm-s-inner .cm-property { color: rgb(0, 0, 0); }
.cm-s-inner .cm-operator { color: rgb(152, 26, 26); }
.cm-s-inner .cm-comment, .cm-s-inner.cm-comment { color: rgb(170, 85, 0); }
.cm-s-inner .cm-string-2 { color: rgb(255, 85, 0); }
.cm-s-inner .cm-meta { color: rgb(85, 85, 85); }
.cm-s-inner .cm-qualifier { color: rgb(85, 85, 85); }
.cm-s-inner .cm-builtin { color: rgb(51, 0, 170); }
.cm-s-inner .cm-bracket { color: rgb(153, 153, 119); }
.cm-s-inner .cm-tag { color: rgb(17, 119, 0); }
.cm-s-inner .cm-attribute { color: rgb(0, 0, 204); }
.cm-s-inner .cm-header, .cm-s-inner.cm-header { color: rgb(0, 0, 255); }
.cm-s-inner .cm-quote, .cm-s-inner.cm-quote { color: rgb(0, 153, 0); }
.cm-s-inner .cm-hr, .cm-s-inner.cm-hr { color: rgb(153, 153, 153); }
.cm-s-inner .cm-link, .cm-s-inner.cm-link { color: rgb(0, 0, 204); }
.cm-negative { color: rgb(221, 68, 68); }
.cm-positive { color: rgb(34, 153, 34); }
.cm-header, .cm-strong { font-weight: 700; }
.cm-del { text-decoration: line-through; }
.cm-em { font-style: italic; }
.cm-link { text-decoration: underline; }
.cm-error { color: red; }
.cm-invalidchar { color: red; }
.cm-constant { color: rgb(38, 139, 210); }
.cm-defined { color: rgb(181, 137, 0); }
div.CodeMirror span.CodeMirror-matchingbracket { color: rgb(0, 255, 0); }
div.CodeMirror span.CodeMirror-nonmatchingbracket { color: rgb(255, 34, 34); }
.cm-s-inner .CodeMirror-activeline-background { background-image: inherit; background-size: inherit; background-attachment: inherit; background-origin: inherit; background-clip: inherit; background-color: inherit; background-position: inherit inherit; background-repeat: inherit inherit; }
.CodeMirror { position: relative; overflow: hidden; }
.CodeMirror-scroll { height: 100%; outline: 0px; position: relative; box-sizing: content-box; background-image: inherit; background-size: inherit; background-attachment: inherit; background-origin: inherit; background-clip: inherit; background-color: inherit; background-position: inherit inherit; background-repeat: inherit inherit; }
.CodeMirror-sizer { position: relative; }
.CodeMirror-gutter-filler, .CodeMirror-hscrollbar, .CodeMirror-scrollbar-filler, .CodeMirror-vscrollbar { position: absolute; z-index: 6; display: none; }
.CodeMirror-vscrollbar { right: 0px; top: 0px; overflow: hidden; }
.CodeMirror-hscrollbar { bottom: 0px; left: 0px; overflow: hidden; }
.CodeMirror-scrollbar-filler { right: 0px; bottom: 0px; }
.CodeMirror-gutter-filler { left: 0px; bottom: 0px; }
.CodeMirror-gutters { position: absolute; left: 0px; top: 0px; padding-bottom: 30px; z-index: 3; }
.CodeMirror-gutter { white-space: normal; height: 100%; box-sizing: content-box; padding-bottom: 30px; margin-bottom: -32px; display: inline-block; }
.CodeMirror-gutter-wrapper { position: absolute; z-index: 4; border: none !important; background-position: 0px 0px !important; background-repeat: initial initial !important; }
.CodeMirror-gutter-background { position: absolute; top: 0px; bottom: 0px; z-index: 4; }
.CodeMirror-gutter-elt { position: absolute; cursor: default; z-index: 4; }
.CodeMirror-lines { cursor: text; }
.CodeMirror pre { border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; border-width: 0px; font-family: inherit; font-size: inherit; margin: 0px; white-space: pre; word-wrap: normal; color: inherit; z-index: 2; position: relative; overflow: visible; background-position: 0px 0px; background-repeat: initial initial; }
.CodeMirror-wrap pre { word-wrap: break-word; white-space: pre-wrap; word-break: normal; }
.CodeMirror-code pre { border-right-width: 30px; border-right-style: solid; border-right-color: transparent; width: fit-content; }
.CodeMirror-wrap .CodeMirror-code pre { border-right-style: none; width: auto; }
.CodeMirror-linebackground { position: absolute; left: 0px; right: 0px; top: 0px; bottom: 0px; z-index: 0; }
.CodeMirror-linewidget { position: relative; z-index: 2; overflow: auto; }
.CodeMirror-wrap .CodeMirror-scroll { overflow-x: hidden; }
.CodeMirror-measure { position: absolute; width: 100%; height: 0px; overflow: hidden; visibility: hidden; }
.CodeMirror-measure pre { position: static; }
.CodeMirror div.CodeMirror-cursor { position: absolute; visibility: hidden; border-right-style: none; width: 0px; }
.CodeMirror div.CodeMirror-cursor { visibility: hidden; }
.CodeMirror-focused div.CodeMirror-cursor { visibility: inherit; }
.cm-searching { background-color: rgba(255, 255, 0, 0.4); background-position: initial initial; background-repeat: initial initial; }
@media print { 
  .CodeMirror div.CodeMirror-cursor { visibility: hidden; }
}


:root {
    --side-bar-bg-color: #fafafa;
    --control-text-color: #777;
}

@include-when-export url(https://fonts.loli.net/css?family=Open+Sans:400italic,700italic,700,400&subset=latin,latin-ext);

html {
    font-size: 16px;
}

body {
    font-family: "Open Sans","Clear Sans","Helvetica Neue",Helvetica,Arial,sans-serif;
    color: rgb(51, 51, 51);
    line-height: 1.6;
}

#write {
    max-width: 860px;
  	margin: 0 auto;
  	padding: 30px;
    padding-bottom: 100px;
}
#write > ul:first-child,
#write > ol:first-child{
    margin-top: 30px;
}

a {
    color: #4183C4;
}
h1,
h2,
h3,
h4,
h5,
h6 {
    position: relative;
    margin-top: 1rem;
    margin-bottom: 1rem;
    font-weight: bold;
    line-height: 1.4;
    cursor: text;
}
h1:hover a.anchor,
h2:hover a.anchor,
h3:hover a.anchor,
h4:hover a.anchor,
h5:hover a.anchor,
h6:hover a.anchor {
    text-decoration: none;
}
h1 tt,
h1 code {
    font-size: inherit;
}
h2 tt,
h2 code {
    font-size: inherit;
}
h3 tt,
h3 code {
    font-size: inherit;
}
h4 tt,
h4 code {
    font-size: inherit;
}
h5 tt,
h5 code {
    font-size: inherit;
}
h6 tt,
h6 code {
    font-size: inherit;
}
h1 {
    padding-bottom: .3em;
    font-size: 2.25em;
    line-height: 1.2;
    border-bottom: 1px solid #eee;
}
h2 {
   padding-bottom: .3em;
    font-size: 1.75em;
    line-height: 1.225;
    border-bottom: 1px solid #eee;
}
h3 {
    font-size: 1.5em;
    line-height: 1.43;
}
h4 {
    font-size: 1.25em;
}
h5 {
    font-size: 1em;
}
h6 {
   font-size: 1em;
    color: #777;
}
p,
blockquote,
ul,
ol,
dl,
table{
    margin: 0.8em 0;
}
li>ol,
li>ul {
    margin: 0 0;
}
hr {
    height: 2px;
    padding: 0;
    margin: 16px 0;
    background-color: #e7e7e7;
    border: 0 none;
    overflow: hidden;
    box-sizing: content-box;
}

li p.first {
    display: inline-block;
}
ul,
ol {
    padding-left: 30px;
}
ul:first-child,
ol:first-child {
    margin-top: 0;
}
ul:last-child,
ol:last-child {
    margin-bottom: 0;
}
blockquote {
    border-left: 4px solid #dfe2e5;
    padding: 0 15px;
    color: #777777;
}
blockquote blockquote {
    padding-right: 0;
}
table {
    padding: 0;
    word-break: initial;
}
table tr {
    border-top: 1px solid #dfe2e5;
    margin: 0;
    padding: 0;
}
table tr:nth-child(2n),
thead {
    background-color: #f8f8f8;
}
table tr th {
    font-weight: bold;
    border: 1px solid #dfe2e5;
    border-bottom: 0;
    margin: 0;
    padding: 6px 13px;
}
table tr td {
    border: 1px solid #dfe2e5;
    margin: 0;
    padding: 6px 13px;
}
table tr th:first-child,
table tr td:first-child {
    margin-top: 0;
}
table tr th:last-child,
table tr td:last-child {
    margin-bottom: 0;
}

.CodeMirror-lines {
    padding-left: 4px;
}

.code-tooltip {
    box-shadow: 0 1px 1px 0 rgba(0,28,36,.3);
    border-top: 1px solid #eef2f2;
}

.md-fences,
code,
tt {
    border: 1px solid #e7eaed;
    background-color: #f8f8f8;
    border-radius: 3px;
    padding: 0;
    padding: 2px 4px 0px 4px;
    font-size: 0.9em;
}

code {
    background-color: #f3f4f4;
    padding: 0 2px 0 2px;
}

.md-fences {
    margin-bottom: 15px;
    margin-top: 15px;
    padding-top: 8px;
    padding-bottom: 6px;
}


.md-task-list-item > input {
  margin-left: -1.3em;
}

@media print {
    html {
        font-size: 13px;
    }
    table,
    pre {
        page-break-inside: avoid;
    }
    pre {
        word-wrap: break-word;
    }
}

.md-fences {
	background-color: #f8f8f8;
}
#write pre.md-meta-block {
	padding: 1rem;
    font-size: 85%;
    line-height: 1.45;
    background-color: #f7f7f7;
    border: 0;
    border-radius: 3px;
    color: #777777;
    margin-top: 0 !important;
}

.mathjax-block>.code-tooltip {
	bottom: .375rem;
}

.md-mathjax-midline {
    background: #fafafa;
}

#write>h3.md-focus:before{
	left: -1.5625rem;
	top: .375rem;
}
#write>h4.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
#write>h5.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
#write>h6.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
.md-image>.md-meta {
    /*border: 1px solid #ddd;*/
    border-radius: 3px;
    padding: 2px 0px 0px 4px;
    font-size: 0.9em;
    color: inherit;
}

.md-tag {
    color: #a7a7a7;
    opacity: 1;
}

.md-toc { 
    margin-top:20px;
    padding-bottom:20px;
}

.sidebar-tabs {
    border-bottom: none;
}

#typora-quick-open {
    border: 1px solid #ddd;
    background-color: #f8f8f8;
}

#typora-quick-open-item {
    background-color: #FAFAFA;
    border-color: #FEFEFE #e5e5e5 #e5e5e5 #eee;
    border-style: solid;
    border-width: 1px;
}

/** focus mode */
.on-focus-mode blockquote {
    border-left-color: rgba(85, 85, 85, 0.12);
}

header, .context-menu, .megamenu-content, footer{
    font-family: "Segoe UI", "Arial", sans-serif;
}

.file-node-content:hover .file-node-icon,
.file-node-content:hover .file-node-open-state{
    visibility: visible;
}

.mac-seamless-mode #typora-sidebar {
    background-color: #fafafa;
    background-color: var(--side-bar-bg-color);
}

.md-lang {
    color: #b4654d;
}

.html-for-mac .context-menu {
    --item-hover-bg-color: #E6F0FE;
}

#md-notification .btn {
    border: 0;
}

.dropdown-menu .divider {
    border-color: #e5e5e5;
}

.ty-preferences .window-content {
    background-color: #fafafa;
}

.ty-preferences .nav-group-item.active {
    color: white;
    background: #999;
}

 .typora-export li, .typora-export p, .typora-export,  .footnote-line {white-space: normal;} 
</style>
<meta name="generator" content="Hexo 4.2.0"></head>
<body class='typora-export' >
<div  id='write'  class = 'is-mac'><h1><a name="objective-c-语言" class="md-header-anchor"></a><span>Objective-C 语言</span></h1><p><span>写这篇文章的时候，我做了一些技术方向调研，愿意是想从0开始写iOS开发，但后来发现这个过程比较漫长而且可能写出来的文章并不那么全面以及容易理解。因此，这篇文章没有介绍iOS开发的初级知识，主要介绍iOS开发中一些比较本质的东西，有助于理解和调试程序，不过某些栏目由于时间关系并未完善。关于iOS开发基础的文章，这里提供一个网站非常优秀的博客系列 </span><a href='https://www.cnblogs.com/mjios/category/459066.html' target="_blank" rel="noopener"><span>C语言</span></a><span>    </span><a href='https://www.cnblogs.com/mjios/category/454764.html' target="_blank" rel="noopener"><span>Objective-C 语言</span></a><span>，这是国内知名培训机构小码哥教育创始人</span><a href='https://www.cnblogs.com/mjios/' target="_blank" rel="noopener"><span>M了个J</span></a><span>写的，他在iOS开发领域有非常流行的两大开源框架</span><a href='https://github.com/CoderMJLee/MJRefresh' target="_blank" rel="noopener"><span>MJRefresh</span></a><span>和</span><a href='https://github.com/CoderMJLee/MJExtension' target="_blank" rel="noopener"><span>MJExtension</span></a><span>。</span></p><p><span>苹果官方文档： </span><a href='https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ProgrammingWithObjectiveC/Introduction/Introduction.html#//apple_ref/doc/uid/TP40011210-CH1-SW1' target="_blank" rel="noopener"><span>Objective-C官方文档</span></a><span>  </span><a href='https://swift.org/about/' target="_blank" rel="noopener"><span>Swift官方文档</span></a><span>  </span><a href='https://developer.apple.com/documentation/uikit/about_app_development_with_uikit' target="_blank" rel="noopener"><span>UIKit官方文档</span></a></p><p><span>优秀博客：</span><a href='https://blog.ibireme.com/author/ibireme/' target="_blank" rel="noopener"><span>ibireme - 供职优酷期间</span></a><span>、</span><a href='https://casatwy.com/iosying-yong-jia-gou-tan-kai-pian.html' target="_blank" rel="noopener"><span>casa - 供职于安居客期间</span></a><span> 、</span><a href='https://zouzzprogrammer.wordpress.com/2016/07/22/ios开源/' target="_blank" rel="noopener"><span>iOS开源聚合</span></a></p><p>&nbsp;</p><h3><a name="1-objective-c简介" class="md-header-anchor"></a><span>1. Objective-C简介</span></h3><p><span>Objective-C简称OC (或ObjC)，1980被Stepstone公司的Brad Cox发明，最初的目的是补充C语言缺少面向对象特性的缺陷，后来随着Apple公司iPhone的火热而流行开来，目前OC主要应用于iOS、MacOSX、iPadOS、WatchOS等苹果系列操作系统中</span></p><blockquote><p><span>Swift是苹果公司2014在WWDC发布，并于2015年WWDC开源，苹果开发这门语言的目的是为了替代OC，宣称性能超过OC近2.6被，然而，某些研究表明，这种差异并不明显。</span></p><p><span>Swift语言主要特点：安全、快速、简短                参考 </span><a href='https://swift.org/about/' target="_blank" rel="noopener"><span>Swift简介</span></a></p><p><span>根据</span><a href='https://insights.stackoverflow.com/survey/2019/#most-popular-technologies' target="_blank" rel="noopener"><span>Stack Overflow</span></a><span>调查，目前OC和Swift热度相差不大。就语言选择来说，如果团队有精通OC的开发人员并且是旧的OC项目建议选择OC（因为目前苹果并没有废弃OC的意向或消息，也或许永远不会这么做，因为Swift部分底层库中仍然用到了OC）；而当团队人员精通Swift或者是新构建的项目，建议使用Swift，毕竟Swift的社区正在逐渐扩大，包括它在Linux上应用也开始广受关注，它相对OC来说还是存在诸多优势。但在一个项目中同时使用OC和Swift不太推荐，这可能需要开发人员同时具备OC和Swift两种语言技能并有深入了解，否则可能起到反效果</span><code>backfire</code><span>。</span></p><p><span>关于OC和Swift对比的文章很多，这里贴</span><a href='https://www.altexsoft.com/blog/engineering/swift-vs-objective-c-out-with-the-old-in-with-the-new/' target="_blank" rel="noopener"><span>altexsoft的一片文章</span></a></p></blockquote><p>&nbsp;</p><p><span>为C添加了面向对象的特性支持，就成了Objective-C，从本质上说OC就是C语言，它完美兼容C/C++语言。OC通过运行时库runtime扩充了C面向对象的特点，但也正因这个扩展，使得OC相对于C带来了不少的性能损耗，比如OC最得意的动态性、消息机制等也成了它主要性能损耗的根源。Apple在当初也面临两种选择，在是继续优化OC还是开发一门新的语言两种选择中陷入了两难境地，最终的方案是两种都尝试一下，也就有了如今的Objective-C和Swift共存的局面。</span></p><p><span>Objective-C最主要的框架是Foundation框架，Foundation基于runtime实现OC中基础类型，并不开源，而与Foundation有类似接口的CoreFoundation则是纯C实现，不过他需要手动管理内存，并不支持ARC机制。CoreFoundation是开源的，它相对于Foundation来说有更高的性能，但由于没有ARC的支持，除非对性能要求比较高的场合或者实现框架时才会使用，平常项目开发中并不多用。</span></p><p>&nbsp;</p><h3><a name="2认识nsobject" class="md-header-anchor"></a><span>2.认识NSObject</span></h3><p><span>NSObject可以说Objective-C中最重要的类，它是OC的最常用的根类(当然OC中还有另一个根类NSProxy，主要用于消息转发)，对于我们天天都接触的NSObject，他是到底是什么，这里我们可以来研究一下。</span></p><p><span>NSObject的本质，我们每天写的OC类几乎都继承自NSObject，但NSObject的底层具体是什么呢？</span><a href='https://opensource.apple.com/tarballs/objc4/' target="_blank" rel="noopener"><span>runtime源码</span></a><span>中可以发现如下信息</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="c"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><span><span>​</span>x</span></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">struct</span> <span class="cm-def">objc_class</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">// OC类，其实就是一个结构体</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">Class</span> <span class="cm-variable">isa</span>; <span class="cm-comment">// objc_class *isa; 一个指向自己的指针</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">struct</span> <span class="cm-def">objc_object</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">// OC对象，其实也是一个结构体，里边有一个指向类结构体的指针</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">Class</span> <span class="cm-variable">isa</span>; <span class="cm-comment">// objc_class *isa; objc_class类型的指针</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">typedef</span> <span class="cm-keyword">struct</span> <span class="cm-def">objc_object</span> <span class="cm-operator">*</span><span class="cm-variable">id</span>; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// objc_object类型的指针(id就是一个指向对象的指针)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">typedef</span> <span class="cm-keyword">struct</span> <span class="cm-def">objc_object</span> <span class="cm-def">NSObject</span>; <span class="cm-comment">// NSObject就是一个（对象结构体objc_object）结构体</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">typedef</span> <span class="cm-keyword">struct</span> <span class="cm-def">objc_class</span> <span class="cm-operator">*</span><span class="cm-variable">Class</span>;<span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-tab" role="presentation" cm-text="	">  </span> <span class="cm-comment">// Class就是一个（类结构体objc_class）的指针</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 264px;"></div><div class="CodeMirror-gutters" style="display: none; height: 264px;"></div></div></div></pre><p><span>从上边的定义可以看出，实际上OC的根类NSObject是一个C语言的结构体objc_object，内部有一个指向objc_class结构体的指针，而OC的对象id实际上是一个objc_object* 指针，由此可见，NSObject类本质上是一个结构体，也就是说，OC中的对象就是结构体的指针。</span></p><p>&nbsp;</p><h3><a name="3内存管理" class="md-header-anchor"></a><span>3.内存管理</span></h3><h5><a name="31-关于mrc手动引用计数）" class="md-header-anchor"></a><span>3.1 关于MRC（手动引用计数）</span></h5><p><span>早期的OC并没有ARC技术，而是程序员需要手动管理内存，换句话说需要考虑每个堆空间对象的生命周期，这非常麻烦，必须时刻关注对象什么时候创建、销毁等，自Apple在iOS5加入ARC后，短短两三年ARC迅速走红，MRC基本被摒弃，目前的项目基本99+%基于ARC构建。</span></p><blockquote><p><span>引用计数技术，发送消息new/alloc/copy```创建对象时，对象的引用计数retainCount为1，给对象发生retainCount会让对象retainCount加1，发生release消息会让引用计数retainCount减1，如果retainCount==0时，对消会被自动销毁。一下是一段案例</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="objective-c"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="objective-c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">NSObject</span> <span class="cm-operator">*</span><span class="cm-variable">obj</span> <span class="cm-operator">=</span> [<span class="cm-variable">NSObject</span> <span class="cm-variable">new</span>]; &nbsp;<span class="cm-comment">// obj retainCount = 1</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[<span class="cm-variable">obj</span> <span class="cm-keyword">retain</span>]; &nbsp;<span class="cm-comment">// obj retainCount = 2</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[<span class="cm-variable">obj</span> <span class="cm-variable">release</span>]; <span class="cm-comment">// obj retainCount = 1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[<span class="cm-variable">obj</span> <span class="cm-variable">release</span>]; <span class="cm-comment">// obj retainCount = 0 --&gt; 对象销毁</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 88px;"></div><div class="CodeMirror-gutters" style="display: none; height: 88px;"></div></div></div></pre><p><span>因此，我们保留一个对象生命周期的方法是使用retain消息，保证对象的retainCount不为0</span></p></blockquote><p>&nbsp;</p><h5><a name="32-关于arc自动引用计数）" class="md-header-anchor"></a><span>3.2 关于ARC（自动引用计数）</span></h5><p><span>顾名思义，无需程序员自动管理内存(引用计数)，不过这个并非是不要求我们懂得内存管理相关知识，实际上如果理解内存管理内容并理解ARC机制，对于写出高性能的代码非常有帮助，而且在Bug调试等方面像带来巨大优势。ARC和垃圾回收机制（如Java的GC）并不相同，它具有更高的性能，因为ARC基本能及时准确的释放对象而GC却需要多维护一个线程并存在一定的延时。这也是为什么Apple从最初的GC方案转变到ARC方案的原因之一。但Java为什么却坚持GC而不使用ARC呢，我想这是语言设计的初衷和一些历史原因造成的，ARC虽好，但却存在一个循环引用的死结</span><code>retain cycle</code><span>,这算是ARC最大的缺陷，因为这会带来一定的学习成本，程序要必须要掌握基本的内存管理知识才能很好地控制以及避免这个问题的发生。实际上循环引用问题不仅发生在某些初级程序员身上，甚至一些经验丰富的工程师也会在不经意间出现循环引用的Bug ~Ops:)。</span></p><p><span>但为了更好的性能或者说为了苹果的老鸟们平滑过渡，新设计的Swift依然使用ARC技术。  这里有一些关于ARC和GC的讨论：</span><a href='https://docs.elementscompiler.com/Concepts/ARCvsGC/' target="_blank" rel="noopener"><span>ARC vs. GC</span></a><span>, </span><a href='https://stackoverflow.com/questions/7874342/what-is-the-difference-between-objective-c-automatic-reference-counting-and-garb' target="_blank" rel="noopener"><span>Stack overflow</span></a><span>,   </span><a href='https://exaud.com/androids-gc-vs-arc-ios-whats-best/' target="_blank" rel="noopener"><span>Android’s GC VS ARC on iOS</span></a></p><p><strong><span>ARC的实现方式</span></strong><span>：前边提到GC需要额外的线程在合适的时机检查对象垃圾并清除，这可能会造成某个时刻CPU的过度占用甚至导致主线程的卡顿，这也说明GC其实是一种运行时机制。而ARC是编译时机制，即在编译时编译器会为我们的OC代码加上自动引用计数，如retain、release、autorelease等，这样在运行时无需一个单独的gc线程，而对象使用完成接收到release消息后，如果引用计数retainCount为0在自动销毁对象。从这一点上看，ARC少一个GC线程且对象及时释放，这是ARC相对于GC的最大优势。</span></p><p><strong><span>如果解决ARC的劣势</span></strong><span>：iOS开发中最常谈到的</span><code>retain cycle</code><span>，如何解决呢，在谈它之前我们需要先了解一下OC当中的对象修饰符，常用的有如下几个</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="objective-c"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="objective-c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">strong</span> : <span class="cm-variable">对象强引用，会让对象的retainCount</span><span class="cm-operator">++</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">weak</span><span class="cm-tab" role="presentation" cm-text="	">  </span> <span class="cm-variable">：对象弱引用，对象的retainCount不变，相对于__unsafe_unretained更安全，但牺牲部分性能</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">copy</span><span class="cm-tab" role="presentation" cm-text="	">  </span> <span class="cm-variable">：分为深拷贝可浅拷贝</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">可变对象</span>(<span class="cm-variable">深拷贝</span>)<span class="cm-variable">，将产生一个新对象，新对象的retainCount</span><span class="cm-operator">=</span><span class="cm-number">1</span><span class="cm-variable">，使用新对象</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">不可变对象</span>(<span class="cm-variable">浅拷贝</span>)<span class="cm-variable">，不会产生新对象，旧对象retainCount</span><span class="cm-operator">++</span><span class="cm-variable">，依然使用旧对象</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">__unsafe_unretained：这个修饰符和weak一样，都不会改变计数器，但却拥有更高性能，缺点是可能会造成野指针错误</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 132px;"></div><div class="CodeMirror-gutters" style="display: none; height: 132px;"></div></div></div></pre><p>&nbsp;</p><p><strong><span>1) 造成循环引用的原因</span></strong><span>: 如下图a中，对象A持有对象B，对象B持有对象A，这样A不是释放，B的retainCount就不会变为0，同样B不释放A的retainCount也不为0，造成A和B互相等待对方释放，以至于都不能释放。为了方便表示这种关系，我们可以使用一个表达式表述,其中</span><code>==&gt;</code><span>表示强引用，</span><code>--&gt;</code><span>表示弱引用，因此图a可以用表达式</span><code>(A==&gt;B &amp;&amp; B==&gt;A)</code><span>表示。图b表示为</span><code>(A==&gt;B &amp;&amp; B--&gt;A)</code></p><p><img src="./images/retain_cycle.png" referrerpolicy="no-referrer" alt="循环引用及解决方案"></p><p><strong><span>2) 循环引用的解决</span></strong><span>: 正如上图a表示，造成循环引用的原因即对象互相持有。总体来说解决方式有两大思路</span></p><ul><li><span>将其中一方对象对对方的引用设置为弱引用，如上图b（c为变种）</span></li><li><span>将其中一个引用强行断开(手动置空</span><code>=nil</code><span>)，如上图图d</span></li></ul><p><span>当然，虽然总体思路为两大思路，但手段比较多，这里介绍上图中三种常用手段</span></p><blockquote><p><span>图b，将其中一方作为弱引用，比如图中A的retainCount不会因为B的弱引用而增加，因此B的存在对A的存在没有任何影响，A对象完成自己的任务后即可销毁，A销毁后B也可正常销毁，常用案例如下</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="objective-c" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="objective-c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">@interface</span> <span class="cm-variable">Student</span> : <span class="cm-variable">NSObject</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">@property</span> (<span class="cm-keyword">nonatomic</span>, <span class="cm-variable">strong</span>) <span class="cm-variable">Teacher</span> <span class="cm-operator">*</span><span class="cm-variable">teacher</span>; <span class="cm-comment">// 这里使用strong</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">@end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">@interface</span> <span class="cm-variable">Teacher</span> : <span class="cm-variable">NSObject</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">@property</span> (<span class="cm-keyword">nonatomic</span>, <span class="cm-variable">weak</span>) <span class="cm-variable">Student</span> <span class="cm-operator">*</span><span class="cm-variable">student</span>; <span class="cm-comment">// 这里使用weak解决循环引用</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">@end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// ----------------------------------------</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Teacher</span> <span class="cm-operator">*</span><span class="cm-variable">teacher</span> <span class="cm-operator">=</span> [<span class="cm-variable">Teacher</span> <span class="cm-variable">new</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Student</span> <span class="cm-operator">*</span><span class="cm-variable">student</span> <span class="cm-operator">=</span> [<span class="cm-variable">Student</span> <span class="cm-variable">new</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 一边是strong，一边是weak，这不会造成循环引用，没有内存泄漏</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">teacher</span>.<span class="cm-variable">student</span> <span class="cm-operator">=</span> <span class="cm-variable">student</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">student</span>.<span class="cm-variable">teacher</span> <span class="cm-operator">=</span> <span class="cm-variable">teacher</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// ---------------------------------------- &nbsp;</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 330px;"></div><div class="CodeMirror-gutters" style="display: none; height: 330px;"></div></div></div></pre><p><span>图c，这其实是图b的一个变种，针对一些系统类不方便直接将A、B之间的引用变为弱引用的情况，如系统定时器NSTimer等，通常我们解决NSTimer的循环引用主要是使用图d的方式，但该方式不够优雅，且使用麻烦，稍有不慎就就造成内存泄漏，这里提个做个大概思路解释，详细的Demo可以查看这里我写的一个开源实现</span><a href='https://github.com/ZengWeiJun/WJWeakTimer' target="_blank" rel="noopener"><span>WJWeakTimer</span></a><span>，主要解决NSTimer和CADisplayLink的循环引用问题</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="objective-c" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="objective-c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">@interface</span> <span class="cm-variable">ViewController</span> : <span class="cm-variable">UIViewController</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">@property</span> (<span class="cm-keyword">nonatomic</span>, <span class="cm-variable">strong</span>) <span class="cm-variable">NSTimer</span> <span class="cm-operator">*</span><span class="cm-variable">timer</span>; <span class="cm-comment">// 这里必须使用strong，否则定时器被释放不工作</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">@end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">@interface</span> <span class="cm-variable">NSTimer</span> : <span class="cm-variable">NSObject</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">@property</span> (<span class="cm-keyword">nonatomic</span>, <span class="cm-variable">strong</span>) <span class="cm-variable">NSTimer</span> <span class="cm-operator">*</span><span class="cm-variable">target</span>; <span class="cm-comment">// NSTimer是系统提供的类，这里无法修改weak</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">@end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// ----------------------------------------</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 1、这里的解决方式可以使用图d的解决方式，只不过代码封装性不强</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 2、第二种解决方式就是将NSTimer向target发生的消息发送到一个代理对象(这里可以使用NSProxy)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp;  然后再让代理对象将该消息转发给ViewController，而代理对ViewController实行weak引用</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp;  这就破除了循环引用，请参考: https://github.com/ZengWeiJun/WJWeakTimer</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// ---------------------------------------- &nbsp;</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 308px;"></div><div class="CodeMirror-gutters" style="display: none; height: 308px;"></div></div></div></pre><p><span>图d，将其中一方引用强制断开</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="objective-c" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="objective-c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">@interface</span> <span class="cm-variable">Student</span> : <span class="cm-variable">NSObject</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">@property</span> (<span class="cm-keyword">nonatomic</span>, <span class="cm-variable">strong</span>) <span class="cm-variable">Teacher</span> <span class="cm-operator">*</span><span class="cm-variable">teacher</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">@end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">@interface</span> <span class="cm-variable">Teacher</span> : <span class="cm-variable">NSObject</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">@property</span> (<span class="cm-keyword">nonatomic</span>, <span class="cm-variable">strong</span>) <span class="cm-variable">Student</span> <span class="cm-operator">*</span><span class="cm-variable">student</span>; <span class="cm-comment">// 这里使用weak</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">@end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// ----------------------------------------</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Teacher</span> <span class="cm-operator">*</span><span class="cm-variable">teacher</span> <span class="cm-operator">=</span> [<span class="cm-variable">Teacher</span> <span class="cm-variable">new</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Student</span> <span class="cm-operator">*</span><span class="cm-variable">student</span> <span class="cm-operator">=</span> [<span class="cm-variable">Student</span> <span class="cm-variable">new</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 两边属性都是strong，有内存泄漏</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">teacher</span>.<span class="cm-variable">student</span> <span class="cm-operator">=</span> <span class="cm-variable">student</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">student</span>.<span class="cm-variable">teacher</span> <span class="cm-operator">=</span> <span class="cm-variable">teacher</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 解决方式：强制断开一边</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">teacher</span>.<span class="cm-variable">student</span> <span class="cm-operator">=</span> <span class="cm-keyword">nil</span> <span class="cm-variable">或者</span> <span class="cm-variable">student</span>.<span class="cm-variable">teacher</span> <span class="cm-operator">=</span> <span class="cm-keyword">nil</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// ----------------------------------------</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 374px;"></div><div class="CodeMirror-gutters" style="display: none; height: 374px;"></div></div></div></pre></blockquote><p>&nbsp;</p><h3><a name="4认识block" class="md-header-anchor"></a><span>4.认识Block</span></h3><p><span>Block是一个非常有魅力的oc代码块，主要用来处理回调任务。它或许看起来有点怪异，但却非常简洁而且让代码聚合性表现的更好。与它相似功能最早的技术可以看看C语言中的函数指针比如</span><code>void(*)(int a)</code><span>，可以非常方便的处理回调任务。这种技术在其他高级语言中也都得到广泛支持，如C++中的Lambda、Swift/JS中的闭包等，此外JDK8中，如果接口中只有一个方法时也可以使用类似的Lambda表达式简化代码。而关于block的实现方式，其实他家都差不多，思想就是使用一个对象，并在内部用方法包装block代码块的代码，因此可以简单的理解block的本质就是一个封装了回调函数的对象，即类似实现某个接口的匿名类。</span></p><blockquote><p><span>注意，C语言中的函数指针并没有对象，而仅仅是一个函数实现的imp指针，不能其他高级语言的闭包、Lambda一概而论。高级语言通常采用接口+匿名类实现，C语言是单纯的函数指针</span></p></blockquote><p><span>我们知道block会造成循环引用，原因就是block是一个对象，而对象相互持有就会造成循环引用。block对象，这个对象将block代码块中代码封装成方法，将方法内所引用到的变量封装成block对象的成员变量(为了保存变量生命后期)。在ARC环境下，这个block对象通常会在堆空间创建，栈空间的的变量会被拷贝到堆空间(如果需要，全局变量等无需拷贝)，而这里的拷贝通常为浅拷贝，如果是值类型如结构体等可能会进行深拷贝(如果需要保留生命周期)。当然，内部拥有</span><code>__block</code><span>修饰的对象或变量时，也会对其进行拷贝。</span></p><p>&nbsp;</p><h5><a name="41-block类" class="md-header-anchor"></a><span>4.1 block类</span></h5><p><span>根据上边介绍，我们知道block是一个对象，那么他所属的类是哪一个类呢？实际上block分为三种，主要根据内存中的位置进行区分：栈、堆、全局区，而它们都继承于block根类</span><code>NSBlock</code><span>，这个类可以使用runtime方法获取验证，最终获得cls类型为NSBlock，这更进一步为我们验证了block是一个对象的想法</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="objective-c"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="objective-c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> (<span class="cm-variable">^block</span>)(<span class="cm-variable-3">void</span>) <span class="cm-operator">=</span> <span class="cm-variable">^</span>{}; <span class="cm-comment">// 创建一个block对象</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">Class</span> <span class="cm-variable">cls</span> <span class="cm-operator">=</span> ((<span class="cm-variable">NSObject</span> <span class="cm-operator">*</span>)<span class="cm-variable">block</span>).<span class="cm-variable">class</span>; <span class="cm-comment">// 获取block的class</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">while</span> (<span class="cm-variable">class_getSuperclass</span>(<span class="cm-variable">cls</span>) <span class="cm-operator">!=</span> [<span class="cm-variable">NSObject</span> <span class="cm-variable">class</span>]) { <span class="cm-comment">// 循环遍历其父类</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">cls</span> <span class="cm-operator">=</span> <span class="cm-variable">class_getSuperclass</span>(<span class="cm-variable">cls</span>); </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 可以得到 cls 为 NSBlock</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 154px;"></div><div class="CodeMirror-gutters" style="display: none; height: 154px;"></div></div></div></pre><p><span>NSBlock为一个抽象类，细分下的block分为以下三个具体类，</span><em><span>NSConcreteStatckBlock、</span></em><span>NSConcreteGlobalBlock和_NSConcreteMallocBlock，这是三个私有类，通常编译器会智能的为我们选用。</span></p><p>&nbsp;</p><h5><a name="42-block的内存管理" class="md-header-anchor"></a><span>4.2 block的内存管理</span></h5><p><span>Block我们通常在ARC下使用时会进行copy，这个过程一般为编辑器自动进行，对block进行copy赋值效果如下表</span></p><figure><table><thead><tr><th><span>Block的具体类（继承至NSBlock）</span></th><th><span>存储域</span></th><th><span>复制(copy)效果</span></th></tr></thead><tbody><tr><td><span>_NSConcreteStatckBlock</span></td><td><span>栈（对应Swift中非逃逸闭包）</span></td><td><span>栈-&gt;堆</span></td></tr><tr><td><span>_NSConcreteGlobalBlock</span></td><td><span>数据域Data段（对应Swift中逃逸闭包）</span></td><td><span>什么也不做</span></td></tr><tr><td><span>_NSConcreteMallocBlock</span></td><td><span>堆（对应Swift中逃逸闭包）</span></td><td><span>引用计数+1</span></td></tr></tbody></table></figure><p><span>ARC下，block赋值推荐使用 block = [block copy]，这样完全不会引起任何问题(无论赋值多少次)，提高安全性</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="objective-c"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="objective-c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">block</span> <span class="cm-operator">=</span> [[[[<span class="cm-variable">block</span> <span class="cm-keyword">copy</span>] <span class="cm-keyword">copy</span>] <span class="cm-keyword">copy</span>] <span class="cm-keyword">copy</span>] <span class="cm-operator">===</span> <span class="cm-variable">block</span> <span class="cm-operator">=</span> [<span class="cm-variable">block</span> <span class="cm-keyword">copy</span>]</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// block中通过copy和dispose管理内存: copy函数 : 将block从栈复制到堆;  dispose函数: 堆上的函数销毁</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 44px;"></div><div class="CodeMirror-gutters" style="display: none; height: 44px;"></div></div></div></pre><p><span>block自动从栈赋值到堆上的时机（通常情况下手动添加copy会更安全）</span></p><blockquote><ul><li><span>【手动】调用block的copy方法</span></li><li><span>【自动】block作为函数返回值时会自动copy</span></li><li><span>【自动】block赋值给成员变量、__strong修饰的id类型的类会自动copy</span></li><li><span>【自动】cocoa框架中含有usingBlock方法或者GCD的API中block会自动copy</span></li></ul></blockquote><p>&nbsp;</p><h5><a name="43-bock修饰的变量" class="md-header-anchor"></a><span>4.3 __bock修饰的变量</span></h5><p><span>举个例子：想要在block内部修改一个变量的的值，需要用 __block修饰该变量</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="objective-c"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="objective-c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">__block</span> <span class="cm-variable-3">int</span> <span class="cm-variable">num</span> <span class="cm-operator">=</span> <span class="cm-number">10</span>;</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">void</span>(<span class="cm-variable">^block</span>)(<span class="cm-variable-3">void</span>) <span class="cm-operator">=</span> <span class="cm-variable">^</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">num</span> <span class="cm-operator">=</span> <span class="cm-number">20</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">};</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">block</span>(); <span class="cm-comment">// 调用该block</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">NSLog</span>(<span class="cm-keyword">@</span><span class="cm-string">"%d"</span>, <span class="cm-variable">num</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 打印 20</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 154px;"></div><div class="CodeMirror-gutters" style="display: none; height: 154px;"></div></div></div></pre><p><span>这里为什么能在block内部修改num变量的值，实际上，这里的你看到的num经过__block修饰以后已经不再是单纯的 int 型num，而是一个结构体num，此时在后边访问num，实际上是访问了num结构体的一个成员</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="objective-c"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="objective-c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// __block int num; 等效代码</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">typedef</span> <span class="cm-keyword">struct</span> <span class="cm-variable">Block_byref_vak_o</span> <span class="cm-variable">num</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable-3">void</span> <span class="cm-operator">*</span><span class="cm-variable">isa</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">num</span> <span class="cm-variable">__forwarding</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable-3">int</span> <span class="cm-variable">val</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 这里之所以有一个指向自己的指针__forwarding，就是为了block发生拷贝的时候，__block也发生拷贝，此时会将栈中的__forwarding指向堆中的__block，保证不论是在栈中还是堆中都获取到同一份变量</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 之后访问num的代码实际上都会变成这样</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">num</span>.<span class="cm-variable">__forwarding</span><span class="cm-operator">-&gt;</span><span class="cm-variable">val</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 242px;"></div><div class="CodeMirror-gutters" style="display: none; height: 242px;"></div></div></div></pre><p>&nbsp;</p><h5><a name="44-破除循环引用的三种方式" class="md-header-anchor"></a><span>4.4 破除循环引用的三种方式</span></h5><ul><li><p><code>__block</code><span> (如果在MRC下，__block是防止对象被retain，以此解除循环引用)</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="objective-c"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="objective-c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 该方式可以控制weak_self的持有周期</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// block内可修改weak_self变量的值</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 注意：该方式必须要执行block才能破出循环引用</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// block_self = nil之后再使用到self，可能会发生野指针错误</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">__block</span> <span class="cm-variable">block_self</span> <span class="cm-operator">=</span> <span class="cm-keyword">self</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">self</span>.<span class="cm-variable">block</span> <span class="cm-operator">=</span> <span class="cm-variable">^</span>{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">NSLog</span>(<span class="cm-keyword">@</span><span class="cm-string">"%@"</span>, <span class="cm-variable">block_self</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">block_self</span> <span class="cm-operator">=</span> <span class="cm-keyword">nil</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">// 这里再使用block_self发生野指针错误</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">};</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 220px;"></div><div class="CodeMirror-gutters" style="display: none; height: 220px;"></div></div></div></pre></li><li><p><span>__weak 推荐方式</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="objective-c"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="objective-c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">__weak</span> <span class="cm-variable">weak_self</span> <span class="cm-operator">=</span> <span class="cm-keyword">self</span>;</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">self</span>.<span class="cm-variable">block</span> <span class="cm-operator">=</span> <span class="cm-variable">^</span>{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">NSLog</span>(<span class="cm-keyword">@</span><span class="cm-string">"%@"</span>, <span class="cm-variable">weak_self</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  };</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 88px;"></div><div class="CodeMirror-gutters" style="display: none; height: 88px;"></div></div></div></pre></li><li><p><span>手动清空block</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="objective-c"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="objective-c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">self</span>.<span class="cm-variable">block</span> <span class="cm-operator">=</span> <span class="cm-variable">^</span>{</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-variable">NSLog</span>(<span class="cm-keyword">@</span><span class="cm-string">"%@"</span>, <span class="cm-variable">weak_self</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> };</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">// 在调用完block后，手动置为nil</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-keyword">self</span>.<span class="cm-variable">block</span> <span class="cm-operator">=</span> <span class="cm-keyword">nil</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 132px;"></div><div class="CodeMirror-gutters" style="display: none; height: 132px;"></div></div></div></pre><hr /><p><strong><span>循环引用更为妥善解决方式：</span></strong><span> block对象强持有（直接持有）self对象，self对象强持有block，通常我们破出循环的方式是是用__weak，但该方式也存在弊端，就是block执行过程中self对象被释放，可能会造成某些未知的异常，一次较为妥善的方式是在block内部对weak变量强引用</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="objective-c"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="objective-c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">__weak</span> <span class="cm-variable">typeof</span>(<span class="cm-keyword">self</span>) <span class="cm-variable">weak_self</span> <span class="cm-operator">=</span> <span class="cm-keyword">self</span>;</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">self</span>.<span class="cm-variable">block</span> <span class="cm-operator">=</span> <span class="cm-variable">^</span>{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">__strong</span> <span class="cm-variable">typeof</span>(<span class="cm-variable">weak_self</span>) <span class="cm-variable">strong_self</span> <span class="cm-operator">=</span> <span class="cm-variable">weak_self</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 防止self提前释放，这里使用临时变量strong_self强引用self</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 这里的strong_self是函数栈中的一个临时变量，函数执行完毕之后，strong_self便会回收</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 因此对self的强引用不再存在</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">NSLog</span>(<span class="cm-keyword">@</span><span class="cm-string">"%@"</span>, <span class="cm-variable">strong_self</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">};</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 176px;"></div><div class="CodeMirror-gutters" style="display: none; height: 176px;"></div></div></div></pre><p><u><span>注意：某些情况下并不能延长self持有时间，self仍然会提前释放，比如gcd的block内部、AFN的网络回调等</span></u></p><p><u><span>提示：block和__block变量结构体类都有isa指针，实际上可以看成是OC中的对象</span></u></p></li></ul><p>&nbsp;</p><h3><a name="5runtime消息机制）" class="md-header-anchor"></a><span>5.runtime（消息机制）</span></h3><p><span>从我们谈到OC来历时就知道，运行库境就是为了扩充C免现对象特性而增加，同时这个库是OC实现消息机制的基础，消息机制是OC的重要特性，OC中的方法调用基本上使用这个机制，这也是OC动态性的重要体现。通常对于C/C++、Java等语言，编译过后，方法的调用基本就确定怎么调用，而OC则不然，它不能再编译器确定具体的方法调用，只能在编译期确定要调用的方法的selector。而在程序真正运行的时候才动态的去类中寻找方法的真是地址，之后再进行调用，由于中间存在这样一个过程，因此OC在面向对象这块实现上更显灵活性。它可以让我们在编译期（或者说写代码的时候）无需具体制定类型，只需要确保在运行时能根据selector和一定的规则寻找到对应的方法即可。当然也提高了方法调用的代价，在许多第三方法库实现中可以看到为了避免消息机制带来的性能损耗而大量使用C函数。</span></p><p><strong><span>消息机制：</span></strong><span>当我我们调用一个方法，比如obj对象有一个run方法，调用的时候通常是这样</span><code>[obj run];</code><span>而这个底层C实际上会变成</span><code>objc_msgSend(obj,@selector(run));</code><span>这就是消息机制的入口函数，表明像obj对象发生了消息，名称叫run，然后会去obj所属的类的方法列表中找寻run方法，找到run方法后进行调用，这个找寻过程所遵循的规则就称为消息机制。</span></p><p><a href='https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Introduction/Introduction.html' target="_blank" rel="noopener"><span>ObjCRuntimeGuide</span></a><span> </span><a href='https://onevcat.com/2012/04/objective-c-runtime/' target="_blank" rel="noopener"><span>深入Objective-C的动态特性</span></a></p><p>&nbsp;</p><h3><a name="6nsrunloop运行循环）" class="md-header-anchor"></a><span>6.NSRunLoop（运行循环）</span></h3><p><span>Runloop技术应该来说在绝大部分的应用程序中都是一门必须的技术，它主要目的是保持程序存活，并且可以不断处理程序的各种交互事件等。我们都知道main方法作为一个程序的入口，如果没有runloop，程序执行完成(代码跑完)后就会终止程序，那情况下就是App一打开就挂掉。因此为了能保持程序不退出，并且处理诸如视图渲染、逻辑运算和用户点击等事件，我们的程序就需要一个runloop。什么是runloop，下边代码是一般语言实现运行循环的通用逻辑。</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="c"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-def">main</span>() {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable-3">int</span> <span class="cm-variable">retVal</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">do</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">// 执行计算</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">// OpenGL渲染</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 网络请求</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 监听、处理点击事件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// ...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span>} <span class="cm-keyword">while</span>(<span class="cm-variable">retVal</span> <span class="cm-operator">==</span> <span class="cm-number">0</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">return</span> <span class="cm-number">0</span>; <span class="cm-comment">// 通常代码永远不会来到这里，程序也就用于不会结束，除非发生异常导致 retVal != 0</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 242px;"></div><div class="CodeMirror-gutters" style="display: none; height: 242px;"></div></div></div></pre><p><strong><span>runloop的意义：</span></strong><span>通常我们不需要用到runloop，不过在某些时候我们可能需要runloop配合做一些事，比如实现线程保活、控制界面刷新时机等，另外可以对定时器计时机制、界面刷新率、对象生命周期(AutoreleasePool)等进行定性分析，可以帮助程序设计出更优的性能方案。通常主线程一定存在一个runloop，而子线程需要我们手动创建才会有。</span></p><p><a href='https://imlifengfeng.github.io/article/487/' target="_blank" rel="noopener"><span>iOS RunLoop详解</span></a></p><p>&nbsp;</p><h3><a name="7多线程" class="md-header-anchor"></a><span>7.多线程</span></h3><p><span>关于多线程的描述，这里不多做叙述，OC拥有非常优秀的多线程支持技术，自从GCD技术推出后，OC的多线程调度效率得到更好的提升，它是内核级别的调度，也是苹果最推荐的多线程技术实现方式，下面我们会花大量的篇幅介绍GCD。</span></p><h5><a name="71-gcd" class="md-header-anchor"></a><span>7.1 GCD</span></h5><p><span>GCD由系统统一管理和调度，即不是有单个APP程序系统管理，多个APP程序中的GCD线程由系统直接管理调度，性能比一般的线程要高。GCD在iOS和OSX的XNU内核上实现，因此无论开发人员怎么编写高质量代码，性能也不可能超过XUN内核级实现的性能</span></p><p>&nbsp;</p><h5><a name="71-常用函数说明" class="md-header-anchor"></a><span>7.1 常用函数说明</span></h5><ul><li><span>dispath_async函数（异步函数）：具备开线程的能力（通常会开线程，但不必须）</span></li></ul><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="objective-c"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="objective-c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 主队列是一个特殊的串行队列，dispatch_async函数将任务添加到主队列时不会开线程</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_async</span>(<span class="cm-variable">dispatch_get_main_queue</span>(), <span class="cm-variable">^</span>{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">NSLog</span>(<span class="cm-keyword">@</span><span class="cm-string">"%@"</span>, <span class="cm-variable">NSThread</span>.<span class="cm-variable">currentThread</span>); <span class="cm-comment">// main thread</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">});</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 88px;"></div><div class="CodeMirror-gutters" style="display: none; height: 88px;"></div></div></div></pre><ul><li><span>dispath_sync函数（同步函数）：不具备开线程的能力（该函数使用不当可能会死锁）</span></li></ul><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="objective-c"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="objective-c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 判断是否会发生死锁，只需要判断当前执行环境和追加任务的执行环境即可</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 即 1.是串行队列 2.dispatch_sync函数内部和外部在同一个线程</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 如果在同一个线程：外部要完成需要依赖内部完成，而内部要等外部完成才能完成，因而形成死锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_queue_t</span> <span class="cm-variable">serial_queue</span> <span class="cm-operator">=</span> <span class="cm-variable">dispatch_queue_create</span>(<span class="cm-string">"serial"</span>, <span class="cm-atom">NULL</span>); <span class="cm-comment">// 串行队列</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_async</span>(<span class="cm-variable">serial_queue</span>, <span class="cm-variable">^</span>{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">NSLog</span>(<span class="cm-keyword">@</span><span class="cm-string">"1-------%@"</span>, <span class="cm-variable">NSThread</span>.<span class="cm-variable">currentThread</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">dispatch_sync</span>(<span class="cm-variable">serial_queue</span>, <span class="cm-variable">^</span>{ <span class="cm-comment">// 死锁位置</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">NSLog</span>(<span class="cm-keyword">@</span><span class="cm-string">"2-------%@"</span>, <span class="cm-variable">NSThread</span>.<span class="cm-variable">currentThread</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  });</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">});</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 220px;"></div><div class="CodeMirror-gutters" style="display: none; height: 220px;"></div></div></div></pre><p>&nbsp;</p><h5><a name="72-常用队列" class="md-header-anchor"></a><span>7.2 常用队列</span></h5><h6><a name="721-串行队列" class="md-header-anchor"></a><span>7.2.1 串行队列</span></h6><p><span>自定义的串行队列越多，开线程就会越多，通常每个串行队列都会开一条线程(最新版本的iOS系统中，并不是必须的)</span></p><p><strong><span>主队列（系统自带串行队列）：</span></strong><span> dispatch_get_main_queue() 主队列，这是一个特殊的串行队列，使用该队列和异步async函数都不会开线程，所有任务都会在主队列中执行。注意，不能使用sync函数将任务添加到主队列中，否则会造成死锁</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="objective-c"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="objective-c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_sync</span>(<span class="cm-variable">dispatch_get_main_queue</span>(), <span class="cm-variable">^</span>{</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// task -- &gt; 造成死锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">});</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 66px;"></div><div class="CodeMirror-gutters" style="display: none; height: 66px;"></div></div></div></pre><p>&nbsp;</p><p><strong><span>自己创建的串行队列</span></strong></p><p><span>（1）单个串行队列</span></p><p><span>串行队列 + 异步函数：无论添加多少任务，都指会开一条线程，并在该线程中执行所有任务</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="objective-c"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="objective-c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_queue_t</span> <span class="cm-variable">serial_queue</span> <span class="cm-operator">=</span> <span class="cm-variable">dispatch_queue_create</span>(<span class="cm-string">"com.nius.serialQueue"</span>, <span class="cm-variable">DISPATCH_QUEUE_SERIAL</span>);</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-number">2000</span>; <span class="cm-variable">i</span><span class="cm-operator">++</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">dispatch_async</span>(<span class="cm-variable">serial_queue</span>, <span class="cm-variable">^</span>{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">NSLog</span>(<span class="cm-keyword">@</span><span class="cm-string">"%d -- %@"</span>, <span class="cm-variable">i</span>, <span class="cm-variable">NSThread</span>.<span class="cm-variable">currentThread</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  });</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 154px;"></div><div class="CodeMirror-gutters" style="display: none; height: 154px;"></div></div></div></pre><p><span>串行队列+同步：不会开线程，也不会异步执行，可视为“无效操作”</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="objective-c"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="objective-c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">NSLog</span>(<span class="cm-keyword">@</span><span class="cm-string">"%@"</span>, <span class="cm-variable">NSThread</span>.<span class="cm-variable">currentThread</span>);</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_queue_t</span> <span class="cm-variable">serial_queue</span> <span class="cm-operator">=</span> <span class="cm-variable">dispatch_queue_create</span>(<span class="cm-string">"com.nius.serialQueue"</span>, <span class="cm-variable">DISPATCH_QUEUE_SERIAL</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-number">20</span>; <span class="cm-variable">i</span><span class="cm-operator">++</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">dispatch_sync</span>(<span class="cm-variable">serial_queue</span>, <span class="cm-variable">^</span>{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">NSLog</span>(<span class="cm-keyword">@</span><span class="cm-string">"%d -- %@"</span>, <span class="cm-variable">i</span>, <span class="cm-variable">NSThread</span>.<span class="cm-variable">currentThread</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  });</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">NSLog</span>(<span class="cm-keyword">@</span><span class="cm-string">"%@"</span>, <span class="cm-variable">NSThread</span>.<span class="cm-variable">currentThread</span>);</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 198px;"></div><div class="CodeMirror-gutters" style="display: none; height: 198px;"></div></div></div></pre><p><span>以上等吗代码等效于：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="objective-c"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="objective-c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">NSLog</span>(<span class="cm-keyword">@</span><span class="cm-string">"%@"</span>, <span class="cm-variable">NSThread</span>.<span class="cm-variable">currentThread</span>);</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-number">20</span>; <span class="cm-variable">i</span><span class="cm-operator">++</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">NSLog</span>(<span class="cm-keyword">@</span><span class="cm-string">"%d -- %@"</span>, <span class="cm-variable">i</span>, <span class="cm-variable">NSThread</span>.<span class="cm-variable">currentThread</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">NSLog</span>(<span class="cm-keyword">@</span><span class="cm-string">"%@"</span>, <span class="cm-variable">NSThread</span>.<span class="cm-variable">currentThread</span>);</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 110px;"></div><div class="CodeMirror-gutters" style="display: none; height: 110px;"></div></div></div></pre><p><span>（2）多个串行队列</span></p><p><span>通常每一个串行队列都只会开一条线程，因此过多的串行队列数量可能导致程序异常，因为每开辟一个线程都要占据一定额内存空间，所以如果瞬间开大量的线程会造成内存空间的急剧上升，而且过多的线程数量或让CPU调度效率降低</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="objective-c"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="objective-c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-number">20000</span>; <span class="cm-variable">i</span><span class="cm-operator">++</span>) {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">NSString</span> <span class="cm-operator">*</span><span class="cm-variable">queueName</span> <span class="cm-operator">=</span> [<span class="cm-variable">NSString</span> <span class="cm-variable">stringWithFormat</span>:<span class="cm-keyword">@</span><span class="cm-string">"com.nius.serialQueue_%d"</span>, <span class="cm-variable">i</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">dispatch_queue_t</span> <span class="cm-variable">serial_queue</span> <span class="cm-operator">=</span> <span class="cm-variable">dispatch_queue_create</span>(<span class="cm-variable">queueName</span>.<span class="cm-variable">UTF8String</span>, <span class="cm-variable">DISPATCH_QUEUE_SERIAL</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">dispatch_async</span>(<span class="cm-variable">serial_queue</span>, <span class="cm-variable">^</span>{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">NSLog</span>(<span class="cm-keyword">@</span><span class="cm-string">"%d -- %@"</span>, <span class="cm-variable">i</span>, <span class="cm-variable">NSThread</span>.<span class="cm-variable">currentThread</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  });</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 176px;"></div><div class="CodeMirror-gutters" style="display: none; height: 176px;"></div></div></div></pre><p>&nbsp;</p><p>&nbsp;</p><h6><a name="722-并发队列" class="md-header-anchor"></a><span>7.2.2 并发队列</span></h6><p><span>并发队列开线程数量由系统决定</span></p><p><strong><span>全局队列（系统自带并发队列）:</span></strong><span> dispatch_get_global_queue(0, 0)：这个是比较常用的并发队列，有4个等级</span></p><p><span>自己创建的队列默认为DEFAULT，如果要设置优先级，可使用dispatch_set_target_queue</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="objective-c"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="objective-c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">DISPATCH_QUEUE_PRIORITY_HIGH</span>  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">高</span>(<span class="cm-variable">最高</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">DISPATCH_QUEUE_PRIORITY_DEFAULT</span> <span class="cm-variable">默认</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">DISPATCH_QUEUE_PRIORITY_LOW</span> <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">低</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">DISPATCH_QUEUE_PRIORITY_BACKGROUND</span> <span class="cm-variable">后台</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 88px;"></div><div class="CodeMirror-gutters" style="display: none; height: 88px;"></div></div></div></pre><p>&nbsp;</p><p><strong><span>自己创建: </span></strong><span>  自己创建的队列最好设置名字，这样在crashLog日志中容易定位</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="objective-c"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="objective-c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_queue_t</span> <span class="cm-variable">queue</span> <span class="cm-operator">=</span> <span class="cm-variable">dispatch_queue_create</span>(<span class="cm-string">"com.nius.concurrentQueue"</span>, <span class="cm-variable">DISPATCH_QUEUE_CONCURRENT</span>);</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 44px;"></div><div class="CodeMirror-gutters" style="display: none; height: 44px;"></div></div></div></pre><p><span>可使用一下代码验证线程开启数量</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="objective-c"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="objective-c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_queue_t</span> <span class="cm-variable">queue</span> <span class="cm-operator">=</span> <span class="cm-variable">dispatch_queue_create</span>(<span class="cm-string">"com.nius.concurrentQueue"</span>, <span class="cm-variable">DISPATCH_QUEUE_CONCURRENT</span>);</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-number">2000</span>; <span class="cm-variable">i</span><span class="cm-operator">++</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">dispatch_async</span>(<span class="cm-variable">queue</span>, <span class="cm-variable">^</span>{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">NSLog</span>(<span class="cm-keyword">@</span><span class="cm-string">"%@"</span>, <span class="cm-variable">NSThread</span>.<span class="cm-variable">currentThread</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  });</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 154px;"></div><div class="CodeMirror-gutters" style="display: none; height: 154px;"></div></div></div></pre><p>&nbsp;</p><h5><a name="73-队列的挂起和恢复" class="md-header-anchor"></a><span>7.3 队列的挂起和恢复</span></h5><p><span>dispath_suspend 挂起队列 、 dispath_resume 恢复队列</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="objective-c"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="objective-c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_queue_t</span> <span class="cm-variable">queue</span> <span class="cm-operator">=</span> <span class="cm-variable">dispatch_queue_create</span>(<span class="cm-string">"concurrent"</span>, <span class="cm-variable">DISPATCH_QUEUE_CONCURRENT</span>);</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_suspend</span>(<span class="cm-variable">queue</span>); <span class="cm-comment">// 添加任务之前先挂起，否则可能不起效果</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-number">10</span>; <span class="cm-variable">i</span><span class="cm-operator">++</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">dispatch_async</span>(<span class="cm-variable">queue</span>, <span class="cm-variable">^</span>{ <span class="cm-variable">NSLog</span>(<span class="cm-keyword">@</span><span class="cm-string">"线程执行任务 %d"</span>, <span class="cm-variable">i</span>); });</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_after</span>(<span class="cm-variable">dispatch_time</span>(<span class="cm-variable">DISPATCH_TIME_NOW</span>, (<span class="cm-variable">int64_t</span>)(<span class="cm-number">3</span> <span class="cm-operator">*</span> <span class="cm-variable">NSEC_PER_SEC</span>)), <span class="cm-variable">dispatch_get_main_queue</span>(), <span class="cm-variable">^</span>{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">dispatch_resume</span>(<span class="cm-variable">queue</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">});</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 198px;"></div><div class="CodeMirror-gutters" style="display: none; height: 198px;"></div></div></div></pre><h5><a name="74-dispathgroupt" class="md-header-anchor"></a><span>7.4 dispath_group_t</span></h5><p><span>Dispath Group可以用来监听一组操作执行结束时机（dispath_group_notify和dispath_group_wait）</span></p><p><strong><span>(1) dispath_group_notify</span></strong></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="objective-c" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="objective-c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_queue_t</span> <span class="cm-variable">mqueue</span> <span class="cm-operator">=</span> <span class="cm-variable">dispatch_get_main_queue</span>();</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_queue_t</span> <span class="cm-variable">squeue</span> <span class="cm-operator">=</span> <span class="cm-variable">dispatch_queue_create</span>(<span class="cm-string">"com.nius.serial"</span>, <span class="cm-variable">DISPATCH_QUEUE_SERIAL</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_queue_t</span> <span class="cm-variable">cqueue</span> <span class="cm-operator">=</span> <span class="cm-variable">dispatch_queue_create</span>(<span class="cm-string">"com.nius.concurrent"</span>, <span class="cm-variable">DISPATCH_QUEUE_CONCURRENT</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_group_t</span> <span class="cm-variable">group</span> <span class="cm-operator">=</span> <span class="cm-variable">dispatch_group_create</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-number">5</span>; <span class="cm-variable">i</span><span class="cm-operator">++</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">dispatch_group_async</span>(<span class="cm-variable">group</span>, <span class="cm-variable">mqueue</span>, <span class="cm-variable">^</span>{ <span class="cm-variable">NSLog</span>(<span class="cm-keyword">@</span><span class="cm-string">"main &nbsp; &nbsp; &nbsp; (%d) - %@"</span>, <span class="cm-variable">i</span>, <span class="cm-variable">NSThread</span>.<span class="cm-variable">currentThread</span>); });</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-number">5</span>; <span class="cm-variable">i</span><span class="cm-operator">++</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">dispatch_group_async</span>(<span class="cm-variable">group</span>, <span class="cm-variable">squeue</span>, <span class="cm-variable">^</span>{ <span class="cm-variable">NSLog</span>(<span class="cm-keyword">@</span><span class="cm-string">"serial &nbsp; &nbsp; (%d) - %@"</span>, <span class="cm-variable">i</span>, <span class="cm-variable">NSThread</span>.<span class="cm-variable">currentThread</span>); });</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-number">5</span>; <span class="cm-variable">i</span><span class="cm-operator">++</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">dispatch_group_async</span>(<span class="cm-variable">group</span>, <span class="cm-variable">cqueue</span>, <span class="cm-variable">^</span>{ <span class="cm-variable">NSLog</span>(<span class="cm-keyword">@</span><span class="cm-string">"concurrent (%d) - %@"</span>, <span class="cm-variable">i</span>, <span class="cm-variable">NSThread</span>.<span class="cm-variable">currentThread</span>); });</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_group_notify</span>(<span class="cm-variable">group</span>, <span class="cm-variable">mqueue</span>, <span class="cm-variable">^</span>{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">NSLog</span>(<span class="cm-keyword">@</span><span class="cm-string">"all finished - %@"</span>, <span class="cm-variable">NSThread</span>.<span class="cm-variable">currentThread</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">});</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 462px;"></div><div class="CodeMirror-gutters" style="display: none; height: 462px;"></div></div></div></pre><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">concurrent (1) - &lt;NSThread: 0x600003a52780&gt;{number = 3, name = (null)}</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">concurrent (3) - &lt;NSThread: 0x600003a3c8c0&gt;{number = 7, name = (null)}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">concurrent (2) - &lt;NSThread: 0x600003a084c0&gt;{number = 4, name = (null)}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">concurrent (0) - &lt;NSThread: 0x600003a34300&gt;{number = 5, name = (null)}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">concurrent (4) - &lt;NSThread: 0x600003a24d00&gt;{number = 8, name = (null)}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">serial &nbsp; &nbsp; (0) - &lt;NSThread: 0x600003a31340&gt;{number = 6, name = (null)}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">serial &nbsp; &nbsp; (1) - &lt;NSThread: 0x600003a31340&gt;{number = 6, name = (null)}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">serial &nbsp; &nbsp; (2) - &lt;NSThread: 0x600003a31340&gt;{number = 6, name = (null)}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">serial &nbsp; &nbsp; (3) - &lt;NSThread: 0x600003a31340&gt;{number = 6, name = (null)}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">serial &nbsp; &nbsp; (4) - &lt;NSThread: 0x600003a31340&gt;{number = 6, name = (null)}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">main &nbsp; &nbsp; &nbsp; (0) - &lt;NSThread: 0x600003a56240&gt;{number = 1, name = main}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">main &nbsp; &nbsp; &nbsp; (1) - &lt;NSThread: 0x600003a56240&gt;{number = 1, name = main}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">main &nbsp; &nbsp; &nbsp; (2) - &lt;NSThread: 0x600003a56240&gt;{number = 1, name = main}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">main &nbsp; &nbsp; &nbsp; (3) - &lt;NSThread: 0x600003a56240&gt;{number = 1, name = main}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">main &nbsp; &nbsp; &nbsp; (4) - &lt;NSThread: 0x600003a56240&gt;{number = 1, name = main}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">all finished - &lt;NSThread: 0x600003a56240&gt;{number = 1, name = main}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 352px;"></div><div class="CodeMirror-gutters" style="display: none; height: 352px;"></div></div></div></pre><p>&nbsp;</p><p><strong><span>(2)引用计数方式</span></strong><span> : 该方式具体案例可以查看dispath_io中异步并发读取文件方式</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang=""><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">在不方便使用dispatch_group_async的地方可以使用以下方式，必须成对出现</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">dispatch_group_enter(group); // 任务开始时，引用计数+1</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">dispatch_group_leave(group); // 任务结束时，引用计数-1</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">dispatch_group_notify(group, queue, ^{引用计数为0时});</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 88px;"></div><div class="CodeMirror-gutters" style="display: none; height: 88px;"></div></div></div></pre><p><strong><span>(3) dispath_group_wait</span></strong></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="objective-c" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="objective-c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_async</span>(<span class="cm-variable">dispatch_get_global_queue</span>(<span class="cm-number">0</span>, <span class="cm-number">0</span>), <span class="cm-variable">^</span>{</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">dispatch_queue_t</span> <span class="cm-variable">mqueue</span> <span class="cm-operator">=</span> <span class="cm-variable">dispatch_get_main_queue</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">dispatch_queue_t</span> <span class="cm-variable">squeue</span> <span class="cm-operator">=</span> <span class="cm-variable">dispatch_queue_create</span>(<span class="cm-string">"com.nius.serial"</span>, <span class="cm-variable">DISPATCH_QUEUE_SERIAL</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">dispatch_queue_t</span> <span class="cm-variable">cqueue</span> <span class="cm-operator">=</span> <span class="cm-variable">dispatch_queue_create</span>(<span class="cm-string">"com.nius.concurrent"</span>, <span class="cm-variable">DISPATCH_QUEUE_CONCURRENT</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">dispatch_group_t</span> <span class="cm-variable">group</span> <span class="cm-operator">=</span> <span class="cm-variable">dispatch_group_create</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-number">5</span>; <span class="cm-variable">i</span><span class="cm-operator">++</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">dispatch_group_async</span>(<span class="cm-variable">group</span>, <span class="cm-variable">mqueue</span>, <span class="cm-variable">^</span>{ <span class="cm-variable">NSLog</span>(<span class="cm-keyword">@</span><span class="cm-string">"main &nbsp; &nbsp; &nbsp; (%d) - %@"</span>, <span class="cm-variable">i</span>, <span class="cm-variable">NSThread</span>.<span class="cm-variable">currentThread</span>); });</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-number">5</span>; <span class="cm-variable">i</span><span class="cm-operator">++</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">dispatch_group_async</span>(<span class="cm-variable">group</span>, <span class="cm-variable">squeue</span>, <span class="cm-variable">^</span>{ <span class="cm-variable">NSLog</span>(<span class="cm-keyword">@</span><span class="cm-string">"serial &nbsp; &nbsp; (%d) - %@"</span>, <span class="cm-variable">i</span>, <span class="cm-variable">NSThread</span>.<span class="cm-variable">currentThread</span>); });</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-number">5</span>; <span class="cm-variable">i</span><span class="cm-operator">++</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">dispatch_group_async</span>(<span class="cm-variable">group</span>, <span class="cm-variable">cqueue</span>, <span class="cm-variable">^</span>{ <span class="cm-variable">NSLog</span>(<span class="cm-keyword">@</span><span class="cm-string">"concurrent (%d) - %@"</span>, <span class="cm-variable">i</span>, <span class="cm-variable">NSThread</span>.<span class="cm-variable">currentThread</span>); });</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 注意：该操作在主线程中操作不当可能如果造成死锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 等待时长 DISPATCH_TIME_FOREVER 一直等待所有执行完成</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 3ull * NSEC_PER_SEC 等待3秒</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// long result = dispatch_group_wait(group, 3ull * NSEC_PER_SEC);</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-3">long</span> <span class="cm-variable">result</span> <span class="cm-operator">=</span> <span class="cm-variable">dispatch_group_wait</span>(<span class="cm-variable">group</span>, <span class="cm-variable">DISPATCH_TIME_FOREVER</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">result</span> <span class="cm-operator">==</span> <span class="cm-number">0</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">NSLog</span>(<span class="cm-keyword">@</span><span class="cm-string">"all finished - %@"</span>, <span class="cm-variable">NSThread</span>.<span class="cm-variable">currentThread</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  } <span class="cm-keyword">else</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">NSLog</span>(<span class="cm-keyword">@</span><span class="cm-string">"某些任务未完成 - %@"</span>, <span class="cm-variable">NSThread</span>.<span class="cm-variable">currentThread</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">});</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 704px;"></div><div class="CodeMirror-gutters" style="display: none; height: 704px;"></div></div></div></pre><h5><a name="75-栅栏函数-dispathbarrierasync" class="md-header-anchor"></a><span>7.5 栅栏函数 dispath_barrier_async</span></h5><p><span>使用场景：当需要在一些列操作中间插入某个任务的时候使用，比如多个线程在读取数据库场景，在某个特殊时刻写入数据的时候需要禁止其他线程读取数据</span></p><p><span>设计数据库时候：可让一张表对应一个线程</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="objective-c" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="objective-c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_queue_t</span> <span class="cm-variable">concurrentQueue</span> <span class="cm-operator">=</span> <span class="cm-variable">dispatch_queue_create</span>(<span class="cm-string">"com.nius.concurrent"</span>, <span class="cm-variable">DISPATCH_QUEUE_CONCURRENT</span>);</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_async</span>(<span class="cm-variable">concurrentQueue</span>, <span class="cm-variable">^</span>{ </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">NSLog</span>(<span class="cm-keyword">@</span><span class="cm-string">"线程1读取数据库"</span>);  [<span class="cm-variable">NSThread</span> <span class="cm-variable">sleepForTimeInterval</span>:<span class="cm-number">2</span>]; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">});</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_async</span>(<span class="cm-variable">concurrentQueue</span>, <span class="cm-variable">^</span>{ </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">NSLog</span>(<span class="cm-keyword">@</span><span class="cm-string">"线程2读取数据库"</span>);  [<span class="cm-variable">NSThread</span> <span class="cm-variable">sleepForTimeInterval</span>:<span class="cm-number">2</span>]; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">});</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_async</span>(<span class="cm-variable">concurrentQueue</span>, <span class="cm-variable">^</span>{ </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">NSLog</span>(<span class="cm-keyword">@</span><span class="cm-string">"线程3读取数据库"</span>);  [<span class="cm-variable">NSThread</span> <span class="cm-variable">sleepForTimeInterval</span>:<span class="cm-number">2</span>]; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">});</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_async</span>(<span class="cm-variable">concurrentQueue</span>, <span class="cm-variable">^</span>{ </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">NSLog</span>(<span class="cm-keyword">@</span><span class="cm-string">"线程4读取数据库"</span>);  [<span class="cm-variable">NSThread</span> <span class="cm-variable">sleepForTimeInterval</span>:<span class="cm-number">2</span>]; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">});</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_async</span>(<span class="cm-variable">concurrentQueue</span>, <span class="cm-variable">^</span>{ </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">NSLog</span>(<span class="cm-keyword">@</span><span class="cm-string">"线程5读取数据库"</span>);  [<span class="cm-variable">NSThread</span> <span class="cm-variable">sleepForTimeInterval</span>:<span class="cm-number">2</span>]; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">});</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 栅栏函数，围住后边的线程</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_barrier_async</span>(<span class="cm-variable">concurrentQueue</span>, <span class="cm-variable">^</span>{ </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">NSLog</span>(<span class="cm-keyword">@</span><span class="cm-string">"该时刻需要将数据写入数据库"</span>); </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  [<span class="cm-variable">NSThread</span> <span class="cm-variable">sleepForTimeInterval</span>:<span class="cm-number">3</span>]; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">});</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_async</span>(<span class="cm-variable">concurrentQueue</span>, <span class="cm-variable">^</span>{ </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">NSLog</span>(<span class="cm-keyword">@</span><span class="cm-string">"线程6读取数据库"</span>);  [<span class="cm-variable">NSThread</span> <span class="cm-variable">sleepForTimeInterval</span>:<span class="cm-number">2</span>]; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">});</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_async</span>(<span class="cm-variable">concurrentQueue</span>, <span class="cm-variable">^</span>{ </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">NSLog</span>(<span class="cm-keyword">@</span><span class="cm-string">"线程7读取数据库"</span>);  [<span class="cm-variable">NSThread</span> <span class="cm-variable">sleepForTimeInterval</span>:<span class="cm-number">2</span>]; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">});</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_async</span>(<span class="cm-variable">concurrentQueue</span>, <span class="cm-variable">^</span>{ </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">NSLog</span>(<span class="cm-keyword">@</span><span class="cm-string">"线程8读取数据库"</span>);  [<span class="cm-variable">NSThread</span> <span class="cm-variable">sleepForTimeInterval</span>:<span class="cm-number">2</span>]; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">});</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 748px;"></div><div class="CodeMirror-gutters" style="display: none; height: 748px;"></div></div></div></pre><h5><a name="56-dispathapply函数" class="md-header-anchor"></a><span>5.6 dispath_apply函数</span></h5><p><span>该函数会处理一系列功能重叠的任务，并阻塞当前线程（建议子线程使用）,猜测内部应该使用dispath_barrier_async函数实现</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="objective-c"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="objective-c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">NSLog</span>(<span class="cm-keyword">@</span><span class="cm-string">"start"</span>);</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_queue_t</span> <span class="cm-variable">queue</span> <span class="cm-operator">=</span> <span class="cm-variable">dispatch_queue_create</span>(<span class="cm-string">"concurrent"</span>, <span class="cm-variable">DISPATCH_QUEUE_CONCURRENT</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_apply</span>(<span class="cm-number">3</span>, <span class="cm-variable">queue</span>, <span class="cm-variable">^</span>(<span class="cm-variable-3">size_t</span> <span class="cm-variable">index</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">NSLog</span>(<span class="cm-keyword">@</span><span class="cm-string">"%zu %@"</span>, <span class="cm-variable">index</span>, <span class="cm-variable">NSThread</span>.<span class="cm-variable">currentThread</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">});</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">NSLog</span>(<span class="cm-keyword">@</span><span class="cm-string">"done"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// start</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 2 &lt;NSThread: 0x6000035a3300&gt;{number = 5, name = (null)}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 0 &lt;NSThread: 0x6000035c2280&gt;{number = 1, name = main}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 1 &lt;NSThread: 0x6000035903c0&gt;{number = 4, name = (null)}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// done</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 264px;"></div><div class="CodeMirror-gutters" style="display: none; height: 264px;"></div></div></div></pre><p><span>应用场景：需要在某个时刻处理一系列的元素</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="objective-c"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="objective-c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_queue_t</span> <span class="cm-variable">queue</span> <span class="cm-operator">=</span> <span class="cm-variable">dispatch_queue_create</span>(<span class="cm-string">"concurrent"</span>, <span class="cm-variable">DISPATCH_QUEUE_CONCURRENT</span>);</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_apply</span>(<span class="cm-variable">array</span>.<span class="cm-variable">count</span>, <span class="cm-variable">queue</span>, <span class="cm-variable">^</span>(<span class="cm-variable-3">size_t</span> <span class="cm-variable">index</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">id</span> <span class="cm-variable">obj</span> <span class="cm-operator">=</span> <span class="cm-variable">array</span>[<span class="cm-variable">index</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// async handle obj</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">});</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 110px;"></div><div class="CodeMirror-gutters" style="display: none; height: 110px;"></div></div></div></pre><h5><a name="77-dispathsemaphoret" class="md-header-anchor"></a><span>7.7 dispath_semaphore_t</span></h5><p><strong><span>（1）控制最大并发量</span></strong></p><p><span>semaphore只能控制最大并发量，但并不能控制线程创建数量</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="objective-c" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="objective-c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_queue_t</span> <span class="cm-variable">queue</span> <span class="cm-operator">=</span> <span class="cm-variable">dispatch_queue_create</span>(<span class="cm-string">"com.nius.concurrent"</span>, <span class="cm-variable">DISPATCH_QUEUE_CONCURRENT</span>);</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// value = 5 代表最大并发量为5</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 当value = 1的时候实际上串行，相当于锁的功能</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_semaphore_t</span> <span class="cm-variable">semaphore</span> <span class="cm-operator">=</span> <span class="cm-variable">dispatch_semaphore_create</span>(<span class="cm-number">5</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-number">100000</span>; <span class="cm-variable">i</span><span class="cm-operator">++</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">dispatch_async</span>(<span class="cm-variable">queue</span>, <span class="cm-variable">^</span>{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 如果当前semaphore的值大于0，就-1后往下执行，否则一直等待</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">dispatch_semaphore_wait</span>(<span class="cm-variable">semaphore</span>, <span class="cm-variable">DISPATCH_TIME_FOREVER</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// Do something...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 通知通知semaphore的值+1，semaphore的valued&gt;0后会直接触发到wait函数</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">dispatch_semaphore_signal</span>(<span class="cm-variable">semaphore</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  });</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 352px;"></div><div class="CodeMirror-gutters" style="display: none; height: 352px;"></div></div></div></pre><p><span>事实上一种更简单的实现方式是使用NSOperationQueue</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="objective-c"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="objective-c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">NSOperationQueue</span> <span class="cm-operator">*</span><span class="cm-variable">processQueue</span> <span class="cm-operator">=</span> [[<span class="cm-variable">NSOperationQueue</span> <span class="cm-variable">alloc</span>] <span class="cm-variable">init</span>];</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">processQueue</span>.<span class="cm-variable">maxConcurrentOperationCount</span> <span class="cm-operator">=</span> <span class="cm-number">4</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-number">10000</span>; <span class="cm-variable">i</span><span class="cm-operator">++</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  [<span class="cm-variable">processQueue</span> <span class="cm-variable">addOperationWithBlock</span>:<span class="cm-variable">^</span>{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// Do something...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">NSLog</span>(<span class="cm-keyword">@</span><span class="cm-string">"%@"</span>, <span class="cm-variable">NSThread</span>.<span class="cm-variable">currentThread</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 176px;"></div><div class="CodeMirror-gutters" style="display: none; height: 176px;"></div></div></div></pre><p><strong><span>（2）某些需要等待的特殊场景</span></strong></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="objective-c"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="objective-c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_semaphore_t</span> <span class="cm-variable">semaphore</span> <span class="cm-operator">=</span> <span class="cm-variable">dispatch_semaphore_create</span>(<span class="cm-number">0</span>);</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">NSLog</span>(<span class="cm-keyword">@</span><span class="cm-string">"开始"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_after</span>(<span class="cm-variable">dispatch_time</span>(<span class="cm-variable">DISPATCH_TIME_NOW</span>, (<span class="cm-variable">int64_t</span>)(<span class="cm-number">3</span> <span class="cm-operator">*</span> <span class="cm-variable">NSEC_PER_SEC</span>)), <span class="cm-variable">queue</span>, <span class="cm-variable">^</span>{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">NSLog</span>(<span class="cm-keyword">@</span><span class="cm-string">"办完事完成 -- &gt; 通知wait"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">dispatch_semaphore_signal</span>(<span class="cm-variable">semaphore</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">});</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 由于当前值是0，等待信号量，当收到semaphore&gt;0是触发wait，wait将value--后向下执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_semaphore_wait</span>(<span class="cm-variable">semaphore</span>, <span class="cm-variable">DISPATCH_TIME_FOREVER</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">NSLog</span>(<span class="cm-keyword">@</span><span class="cm-string">"完成"</span>);</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 198px;"></div><div class="CodeMirror-gutters" style="display: none; height: 198px;"></div></div></div></pre><p>&nbsp;</p><p><strong><span>5.8 dispath_once</span></strong></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang=""><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">static dispatch_once_t onceToken;</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">dispatch_once(&amp;onceToken, ^{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  // 此处代码仅仅会执行一次，计时在多线程情况下也百分之百安全</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  // 最常用的就是单例的创建</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">});</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 110px;"></div><div class="CodeMirror-gutters" style="display: none; height: 110px;"></div></div></div></pre><h5><a name="78-dispathio" class="md-header-anchor"></a><span>7.8 dispath_io</span></h5><p><span>将文件为一块一块的读取，会提升读取性能</span></p><p><strong><span>（1）异步串行读取文件</span></strong></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="objective-c" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="objective-c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 异步串行读取文件</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">NSString</span> <span class="cm-operator">*</span><span class="cm-variable">path</span> <span class="cm-operator">=</span> [[<span class="cm-variable">NSBundle</span> <span class="cm-variable">mainBundle</span>] <span class="cm-variable">pathForResource</span>:<span class="cm-keyword">@</span><span class="cm-string">"技术部团建"</span> <span class="cm-variable">ofType</span>:<span class="cm-keyword">@</span><span class="cm-string">"mp4"</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">long</span> <span class="cm-variable-3">long</span> <span class="cm-variable">fileSize</span> <span class="cm-operator">=</span> [[<span class="cm-variable">NSFileManager</span> <span class="cm-variable">defaultManager</span>] <span class="cm-variable">attributesOfItemAtPath</span>:<span class="cm-variable">path</span> <span class="cm-variable">error</span>:<span class="cm-keyword">nil</span>].<span class="cm-variable">fileSize</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">NSString</span> <span class="cm-operator">*</span><span class="cm-variable">destPath</span> <span class="cm-operator">=</span> <span class="cm-keyword">@</span><span class="cm-string">"/Users/nius/Desktop/Test4/Test4/ssss1.mp4"</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_queue_t</span> <span class="cm-variable">pipeQueue</span> <span class="cm-operator">=</span> <span class="cm-variable">dispatch_queue_create</span>(<span class="cm-string">"com.nius.PipeQueue"</span>, <span class="cm-atom">NULL</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_fd_t</span> <span class="cm-variable">fd</span> <span class="cm-operator">=</span> <span class="cm-variable">open</span>(<span class="cm-variable">path</span>.<span class="cm-variable">UTF8String</span>, <span class="cm-variable">O_RDONLY</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_io_t</span> <span class="cm-variable">pipeChannel</span> <span class="cm-operator">=</span> <span class="cm-variable">dispatch_io_create</span>(<span class="cm-variable">DISPATCH_IO_STREAM</span>, <span class="cm-variable">fd</span>, <span class="cm-variable">pipeQueue</span>, <span class="cm-variable">^</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">error</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">close</span>(<span class="cm-variable">fd</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">});</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">size_t</span> <span class="cm-variable">low_water</span> <span class="cm-operator">=</span> <span class="cm-number">20</span> <span class="cm-operator">*</span> <span class="cm-number">1024</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_io_set_low_water</span>(<span class="cm-variable">pipeChannel</span>, <span class="cm-variable">low_water</span>); <span class="cm-comment">// 最小读取量 bytes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_io_set_high_water</span>(<span class="cm-variable">pipeChannel</span>, <span class="cm-variable">low_water</span>); <span class="cm-comment">// 最大读取量 bytes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">NSMutableData</span> <span class="cm-operator">*</span><span class="cm-variable">muData</span> <span class="cm-operator">=</span> [<span class="cm-variable">NSMutableData</span> <span class="cm-variable">data</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_io_read</span>(<span class="cm-variable">pipeChannel</span>, <span class="cm-number">0</span>, <span class="cm-variable">fileSize</span>, <span class="cm-variable">pipeQueue</span>, <span class="cm-variable">^</span>(<span class="cm-variable">bool</span> <span class="cm-variable">done</span>, <span class="cm-variable">dispatch_data_t</span> &nbsp;<span class="cm-variable">_Nullable</span> <span class="cm-variable">data</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">error</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">error</span> <span class="cm-operator">==</span> <span class="cm-number">0</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// NSLog(@"serial:%@", NSThread.currentThread);</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">size_t</span> <span class="cm-variable">len</span> <span class="cm-operator">=</span> <span class="cm-variable">dispatch_data_get_size</span>(<span class="cm-variable">data</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">len</span> <span class="cm-operator">&gt;</span> <span class="cm-number">0</span>) { [<span class="cm-variable">muData</span> <span class="cm-variable">appendData</span>:(<span class="cm-variable">NSData</span><span class="cm-operator">*</span>)<span class="cm-variable">data</span>]; }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">done</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  [[<span class="cm-variable">NSFileManager</span> <span class="cm-variable">defaultManager</span>] <span class="cm-variable">createFileAtPath</span>:<span class="cm-variable">destPath</span> <span class="cm-variable">contents</span>:<span class="cm-variable">muData</span> <span class="cm-variable">attributes</span>:<span class="cm-keyword">nil</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">});</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 660px;"></div><div class="CodeMirror-gutters" style="display: none; height: 660px;"></div></div></div></pre><p><strong><span>（2）异步并行读取文件</span></strong></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="objective-c" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="objective-c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 异步并行读取文件</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">NSString</span> <span class="cm-operator">*</span><span class="cm-variable">path</span> <span class="cm-operator">=</span> [[<span class="cm-variable">NSBundle</span> <span class="cm-variable">mainBundle</span>] <span class="cm-variable">pathForResource</span>:<span class="cm-keyword">@</span><span class="cm-string">"test"</span> <span class="cm-variable">ofType</span>:<span class="cm-keyword">@</span><span class="cm-string">"mp4"</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">long</span> <span class="cm-variable-3">long</span> <span class="cm-variable">fileSize</span> <span class="cm-operator">=</span> [[<span class="cm-variable">NSFileManager</span> <span class="cm-variable">defaultManager</span>] <span class="cm-variable">attributesOfItemAtPath</span>:<span class="cm-variable">path</span> <span class="cm-variable">error</span>:<span class="cm-keyword">nil</span>].<span class="cm-variable">fileSize</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">NSString</span> <span class="cm-operator">*</span><span class="cm-variable">destPath</span> <span class="cm-operator">=</span> <span class="cm-keyword">@</span><span class="cm-string">"/Users/nius/Desktop/Test4/Test4/ssss2.mp4"</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_queue_t</span> <span class="cm-variable">pipeQueue</span> <span class="cm-operator">=</span> <span class="cm-variable">dispatch_queue_create</span>(<span class="cm-string">"com.nius.PipeQueue"</span>, <span class="cm-variable">DISPATCH_QUEUE_CONCURRENT</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_fd_t</span> <span class="cm-variable">fd</span> <span class="cm-operator">=</span> <span class="cm-variable">open</span>(<span class="cm-variable">path</span>.<span class="cm-variable">UTF8String</span>, <span class="cm-variable">O_RDONLY</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_io_t</span> <span class="cm-variable">pipeChannel</span> <span class="cm-operator">=</span> <span class="cm-variable">dispatch_io_create</span>(<span class="cm-variable">DISPATCH_IO_STREAM</span>, <span class="cm-variable">fd</span>, <span class="cm-variable">pipeQueue</span>, <span class="cm-variable">^</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">error</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">close</span>(<span class="cm-variable">fd</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">});</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">off_t</span> <span class="cm-variable">stepSize</span> <span class="cm-operator">=</span> <span class="cm-number">20</span> <span class="cm-operator">*</span> <span class="cm-number">1024</span>; <span class="cm-comment">// 这里需要综合考虑，防止创建过多线程</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">size_t</span> <span class="cm-variable">curSize</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">NSMutableData</span> <span class="cm-operator">*</span><span class="cm-variable">totalData</span> <span class="cm-operator">=</span> [[<span class="cm-variable">NSMutableData</span> <span class="cm-variable">alloc</span>] <span class="cm-variable">initWithLength</span>:<span class="cm-variable">fileSize</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_group_t</span> <span class="cm-variable">group</span> <span class="cm-operator">=</span> <span class="cm-variable">dispatch_group_create</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">while</span> (<span class="cm-variable">curSize</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">fileSize</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 通知 group,下个任务要放入 group 中执行了</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 将group中未完成任务树+1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">dispatch_group_enter</span>(<span class="cm-variable">group</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">dispatch_io_read</span>(<span class="cm-variable">pipeChannel</span>, <span class="cm-variable">curSize</span>, <span class="cm-variable">stepSize</span>, <span class="cm-variable">pipeQueue</span>, <span class="cm-variable">^</span>(<span class="cm-variable">bool</span> <span class="cm-variable">done</span>, <span class="cm-variable">dispatch_data_t</span> &nbsp;<span class="cm-variable">_Nullable</span> <span class="cm-variable">data</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">error</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">error</span> <span class="cm-operator">==</span> <span class="cm-number">0</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// NSLog(@"concurrent:%@", NSThread.currentThread);</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">size_t</span> <span class="cm-variable">len</span> <span class="cm-operator">=</span> <span class="cm-variable">dispatch_data_get_size</span>(<span class="cm-variable">data</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">len</span> <span class="cm-operator">&gt;</span> <span class="cm-number">0</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 这里不能用拼接的方式，需要用替换</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">const</span> <span class="cm-variable-3">void</span> <span class="cm-operator">*</span><span class="cm-variable">bytes</span> <span class="cm-operator">=</span> <span class="cm-atom">NULL</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  (<span class="cm-variable-3">void</span>)<span class="cm-variable">dispatch_data_create_map</span>(<span class="cm-variable">data</span>, <span class="cm-operator">&amp;</span><span class="cm-variable">bytes</span>, <span class="cm-operator">&amp;</span><span class="cm-variable">len</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  [<span class="cm-variable">totalData</span> <span class="cm-variable">replaceBytesInRange</span>:<span class="cm-variable">NSMakeRange</span>(<span class="cm-variable">curSize</span>, <span class="cm-variable">len</span>) <span class="cm-variable">withBytes</span>:<span class="cm-variable">bytes</span> <span class="cm-variable">length</span>:<span class="cm-variable">len</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">done</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 通知 group,任务成功完成,要移除,与 enter成对出现</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 将group中未完成任务树-1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">dispatch_group_leave</span>(<span class="cm-variable">group</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  });</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">curSize</span> <span class="cm-operator">+=</span> <span class="cm-variable">stepSize</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_group_notify</span>(<span class="cm-variable">group</span>, <span class="cm-variable">pipeQueue</span>, <span class="cm-variable">^</span>{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 未完成任务树为0时调用</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  [[<span class="cm-variable">NSFileManager</span> <span class="cm-variable">defaultManager</span>] <span class="cm-variable">createFileAtPath</span>:<span class="cm-variable">destPath</span> <span class="cm-variable">contents</span>:<span class="cm-variable">totalData</span> <span class="cm-variable">attributes</span>:<span class="cm-keyword">nil</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">});</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 1100px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1100px;"></div></div></div></pre><p>&nbsp;</p><h5><a name="79-其他多线程技术包括nsthreadnsoperationpthread" class="md-header-anchor"></a><span>7.9 其他多线程技术包括NSThread、NSOperation、pthread</span></h5><p><span>其中pthread是纯C跨平台的，使用评率非常低，而NSOperation在处理某些复杂任务是，可能会比GCD方便很多，比如处理请求之间依赖关系等。NSThread使用也不多，除非在某些时候需要手动控制线程生命周期，实现线程保活技术等时会使用到。关于这两种实现方式这里不做说明，下面贴两篇文章</span></p><p><a href='https://www.jianshu.com/p/c7b5fd2c5a5a' target="_blank" rel="noopener"><span>NSThread</span></a><span>、 </span><a href='https://juejin.im/post/5a9e57af6fb9a028df222555' target="_blank" rel="noopener"><span>『NSOperation、NSOperationQueue』详尽总结</span></a></p><p>&nbsp;</p><h3><a name="8-锁的使用" class="md-header-anchor"></a><span>8. 锁的使用</span></h3><p><span>关于 iOS中锁的类型，下图是</span><a href='https://blog.ibireme.com/2016/01/16/spinlock_is_unsafe_in_ios/' target="_blank" rel="noopener"><span>ibireme锁的性能测试</span></a><span>数据，比较有参考意义。</span></p><p><img src="./images/lock_benchmark.png" referrerpolicy="no-referrer" alt="iOS中锁的类型"></p><p><span>通常在项目中使用较多的锁是NSLock和@synchronized，这两个锁由于使用简单，可以发现在大部分项目代码中都有出现，而synchronized由于在其他语言（如java）中也有，因此被广泛使用，不过该锁效率在iOS较低。如果追求较极致的性能，这里推荐使用dispatch_semphore和pthread_mutext</span></p><p><span>dispatch_semphore信号量在没有等待时，效率非常高，比pthread_mutext更优，不过一点出现等待，效率会比pthread_mutext还低。它最大优势在于等待时不会消耗cpu资源，它比较适合处理一些没有等待（比如简单数组的CRUD操作等）或者等待时间较长（比如定时清除缓存、网络下载等任务）的情形。pthread_mutext则比较适合处理一些可能有少许等待的情形，通常这个不是特别好把控，一般情况下如果不知道怎么选择，就使用dispatch_semphore即可</span></p><p><span>不推荐OSSpinLock（自旋锁）由于在iOS10之后，系统维护了5个不同优先级线程（background，utility，default，user-initiated，user-interactive），该锁效率虽最高，但该调度算法极有可能造成线程优先级反转问题。</span></p><p>&nbsp;</p><h1><a name="ui高级" class="md-header-anchor"></a><span>UI高级</span></h1><p><span>这个部分主要UI的一些高级使用，包括图形绘制、动画处理、图片优化等</span></p><h3><a name="1-uikit架构" class="md-header-anchor"></a><span>1. UIKit架构</span></h3><p><span>UIKit是iOS中最主要的UI骨架基础，基于该框架能实现App 99%以上的UI，它封装了绝大部分常用控件和动画效果实现，下面是UIKit的一个骨架图</span></p><p><img src="./images/uikit-framework.jpg" referrerpolicy="no-referrer" alt="UIKit"></p><h3><a name="2-设置uiview圆角" class="md-header-anchor"></a><span>2. 设置UIView圆角</span></h3><p><span>圆角设置，通常我们设置圆角是直接使用UIView的layer.cornerRadius和layer.masksToBounds属性，不过该特性可能会导致离屏渲染，带来一定的GPU性能问题，导致UI出现卡顿。但在一般的页面对性能要求没那么高是可以不考虑。而另一个较为重要的需求则是给UIView实现部分圆角，这个需要使用到贝塞尔曲线实现，以下为两个使用案例</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="objective-c" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="objective-c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 通常情况吓设置圆角</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">view</span>.<span class="cm-variable">layer</span>.<span class="cm-variable">cornerRadius</span> <span class="cm-operator">=</span> <span class="cm-number">5</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">view</span>.<span class="cm-variable">layer</span>.<span class="cm-variable">masksToBounds</span> <span class="cm-operator">=</span> <span class="cm-atom">YES</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 设置部分圆角（view的左上角为圆角，其他角不变）,我们需要用到贝塞尔曲线 + CAShapeLayer</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">/** 这里有几个点需要理解</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">1.圆角参数：cornerRadii，为什么要设计为CGSize类型</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">2.view的Layer有一个mask属性</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">关于这两个问题我们后边详细分析</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">CGSize</span> <span class="cm-variable">cornerRadii</span> <span class="cm-operator">=</span> <span class="cm-variable">CGSizeMake</span>(<span class="cm-number">5</span>, <span class="cm-number">5</span>); <span class="cm-comment">// 第二个半径iOS7后失效(后边介绍)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">UIBezierPath</span> <span class="cm-operator">*</span><span class="cm-variable">bezierPath</span> <span class="cm-operator">=</span> [<span class="cm-variable">UIBezierPath</span> <span class="cm-variable">bezierPathWithRoundedRect</span>:<span class="cm-variable">view</span>.<span class="cm-variable">bounds</span> <span class="cm-variable">byRoundingCorners</span>:<span class="cm-variable">UIRectCornerTopLeft</span> <span class="cm-variable">cornerRadii</span>:<span class="cm-variable">cornerRadii</span>]<span class="cm-variable">；</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">CAShapeLayer</span> <span class="cm-operator">*</span><span class="cm-variable">shapeLayer</span> <span class="cm-operator">=</span> [<span class="cm-variable">CAShapeLayer</span> <span class="cm-variable">new</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">shapeLayer</span>.<span class="cm-variable">path</span> <span class="cm-operator">=</span> <span class="cm-variable">bezierPath</span>.<span class="cm-variable">CGPath</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">view</span>.<span class="cm-variable">layer</span>.<span class="cm-variable">mask</span> <span class="cm-operator">=</span> <span class="cm-variable">shapeLayer</span>;</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 352px;"></div><div class="CodeMirror-gutters" style="display: none; height: 352px;"></div></div></div></pre><p>&nbsp;</p><h5><a name="21-圆角实现原理" class="md-header-anchor"></a><span>2.1 圆角实现原理</span></h5><p><span>下图为UIView实现圆角的基本原理，可以简单的这样理解：就是使用两条邻边的内切圆或者椭圆实现，如下图红线外沿将会被切掉，如此便形成了以红线为边缘的圆角。</span></p><p><img src="./images/cornerRadius.png" referrerpolicy="no-referrer" alt="圆角实现原理"></p><h5><a name="22-解决疑问" class="md-header-anchor"></a><span>2.2 解决疑问</span></h5><p><span>从2.1的图中我们可以清晰的看到圆角实现的一个原理，知道实现圆角其实有两种方式，一种是内切圆，另一种则是内切椭圆。内切圆的方式比较简单，基本就是给一个radius半径参数，而内切椭圆的方式则稍微复杂点，不过殊途同归。</span></p><p><span>cornerRadii：按照按照官方文档意思是椭圆的两个半径，通常可是实现为2.1中第二个图的方式，不过奇怪的是，当我们改变cornerRadii的第二个分量时发现没有效果，原来Apple在iOS7之后，将实现方式改为圆而不用椭圆，他们认为使用该方法实现的圆角椭圆需求较少，而原形需求较大，故直接改了底层的实现方式而上层API没有动，这个有点坑，不过只要知道这一点就行，以后使用cornerRadii参数时将两个分量的值传一致就行</span><code>CGSize cornerRadii = CGSizeMake(5, 5)</code><span>，虽然第二个值没有实际用处但防止将来apple修改底层实现带来某些可能的意外问题。</span></p><p><span>关于cornerRadii 的第二个参数失效问题，可以参考 </span><a href='https://stackoverflow.com/questions/18880919/why-is-cornerradii-parameter-of-cgsize-type-in-uibezierpath-bezierpathwithroun' target="_blank" rel="noopener"><span>stackoverflow</span></a><span> 这里有一些讨论</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang=""><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">+ (instancetype)bezierPathWithRoundedRect:(CGRect)rect byRoundingCorners:(UIRectCorner)corners cornerRadii:(CGSize)cornerRadii;</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 44px;"></div><div class="CodeMirror-gutters" style="display: none; height: 44px;"></div></div></div></pre><p><span>贝塞尔曲线的使用可以参考 </span><a href='https://www.jianshu.com/p/4e8fdfb9e33f' target="_blank" rel="noopener"><span>简书UIBezierPath详解</span></a><span>, 还可以配合CoreGraphics中的CGPath实现更加灵活的控制，贝塞尔曲线可以有一下集中组合方式，可以实现非常多的图形技术</span></p><blockquote><ul><li><span>在 -(void)drawRect:(CGRect)rect： 中使直接使用UIBezierPath绘图（不推荐）</span></li><li><span>CAShapeLayer + [view.layer addSublayer:] ：使用shapeLayer绘图（推荐，有硬件加速功能）</span></li><li><span>CAShapeLayer + layer.mask：这种方式主要控制形状</span></li></ul></blockquote><p><span>这里：一半对于实现圆角、控制view的形状的等见识使用CAShapeLayer + layer.mask方式，而实现更复杂或精细控制形状是建议使用CAShapeLayer + [view.layer addSublayer:]方式，CAShapeLayer拥有更高的性能并支持硬件加速，这里有一片CAShapeLayer实现高级动画的文章</span><a href='https://www.jianshu.com/p/08b01396ee6c' target="_blank" rel="noopener"><span>简书iOS CAShapeLayer 使用</span></a></p><p>&nbsp;</p><h3><a name="3-coregraphics基于quartz-2d--coregrpaphicshttpsdeveloperapplecomlibraryarchivedocumentationgraphicsimagingconceptualdrawingwithquartz2dintroductionintroductionhtml" class="md-header-anchor"></a><span>3. CoreGraphics(基于QuartZ 2D)  </span><a href='https://developer.apple.com/library/archive/documentation/GraphicsImaging/Conceptual/drawingwithquartz2d/Introduction/Introduction.html' target="_blank" rel="noopener"><span>CoreGrpaphics</span></a></h3><p><a href='https://www.jianshu.com/p/8c2bda98ad6e' target="_blank" rel="noopener"><span>简书Core Graphics-绘图使用介绍</span></a><span> </span><a href='https://juejin.im/entry/59c117256fb9a00a6b6e630f' target="_blank" rel="noopener"><span>iOS 札记2：Core Graphics小记</span></a></p><p><span>Core Graphic(又名QuartZ 2D)框架是一组基于C的API，可以用于一切绘图操作。Core Graphics是对底层C语言的一个简单封装，其中提供大量的低层次，轻量级的2D渲染API，并且</span><strong><a href='https://stackoverflow.com/questions/11355787/is-this-core-graphics-code-thread-safe' target="_blank" rel="noopener"><span>CoreGraphics是线程安全的</span></a></strong><span>。</span></p><p><span>Core GraphicsAPI简单易于使用，并且提供了强大的功能访问，如透明层，基于路径的图层绘制，屏幕外呈现，高级色彩管理，抗锯齿以及PDF文档的生成解析操作。</span></p><blockquote><p><span>图形上下文：可以理解为一块画布，一个应用中可能有多个上下文环境即多块画布，存在一个画布栈stack中，通常</span><strong><span>使用crrent方法获得画布即为栈顶的画布(栈顶的画布不一定就显示)</span></strong><span>。画布可以被渲染出来也可能不被渲染，比如我们某个时刻想要裁剪一张图片可能会新创建一块画布，绘制好后从画布中取出图片然后将画布销毁，这种画布不会入栈，只是一块临时画布，而一块画布中也可能存在多种状态，用状态栈来维护，栈顶状态为当前画布状态。</span><strong><em><span>当前画布即为栈顶画布</span></em></strong><span>，一个画布可能对应多个状态</span></p><p><span>上下文状态栈：在一块画布上画图可能有多种状态，比如使用的笔的颜色、粗细等，画出的线应该是虚线、实线又或者其他特性等等，这些笔或者线等的状态需要记录，也就记录在我们的图形上下文环境中，这个环境中有一个状态栈stack专门用来保存当前状态，</span><strong><span>栈顶中保存的状态即为当前状态(当前绘制使用的状态)</span></strong><span>，亦可称为当前状态。</span><strong><em><span>当前状态即为栈顶状态</span></em></strong></p></blockquote><h5><a name="31-部分函数说明" class="md-header-anchor"></a><span>3.1 部分函数说明</span></h5><p><strong><span>使用UIView提供的上下文</span></strong><span>：有时候我们自定义一个UIView，在该UIView的drawRect方法中绘制图形，该方式无需我们自己创建图形上下文，而是UIKit自动帮我们创建好。</span></p><blockquote><p><span>-drawRect: UIView的drawRect被实现是（无论是否为空方法），UIKit都会为其创建渲染上下文</span></p></blockquote><blockquote><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="objective-c"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="objective-c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">@interface</span> <span class="cm-variable">CustomView</span> : <span class="cm-variable">UIView</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">@end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">@implementation</span> <span class="cm-variable">CustomView</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">-</span> (<span class="cm-variable-3">void</span>)<span class="cm-variable">drawRect</span>:(<span class="cm-variable">CGRect</span>)<span class="cm-variable">rect</span> { <span class="cm-comment">// 实际上这里UIKit会自动创建上下文画布</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// draw in here...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">@end</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 154px;"></div><div class="CodeMirror-gutters" style="display: none; height: 154px;"></div></div></div></pre></blockquote><p>&nbsp;</p><p><strong><span>创建上下文</span></strong><span>：有时候我们不想使用drawRect方法，需要手动创建图形上下文，通常这个时候我们直接使用CoreGraphics的API实现绘图功能，可能还需要使用UIGraphicsGetCurrentContext获取到我们创建的上下文进行操作。</span></p><blockquote><p><span>UIGraphicsBeginImageContext() :  创建一个位图上下文</span></p><p><span>UIGraphicsEndImageContext(): 结束当前位图上下文</span></p><p><span>UIGraphicsGetCurrentContext(): 获取当前上下文</span></p></blockquote><blockquote><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="objective-c"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="objective-c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">UIGraphicsBeginImageContext</span>(<span class="cm-variable">CGSizeMake</span>(<span class="cm-number">100</span>, <span class="cm-number">100</span>)); <span class="cm-comment">// 创建一块位图画布,会设置为当前context</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">CGContextRef</span> <span class="cm-variable">ctx</span> <span class="cm-operator">=</span> <span class="cm-variable">UIGraphicsGetCurrentContext</span>(); &nbsp;<span class="cm-comment">// 获取当前画布</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// draw in here...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 这里默认ctx就是当前的绘制上下文</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">UIImage</span> <span class="cm-operator">*</span><span class="cm-variable">image</span> <span class="cm-operator">=</span> <span class="cm-variable">UIGraphicsGetImageFromCurrentImageContext</span>(); <span class="cm-comment">// 取得图片</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">UIGraphicsEndImageContext</span>(); <span class="cm-comment">// 销毁画布</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// UIGraphicsBeginImageContext与UIGraphicsEndImageContext是一对cp</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 154px;"></div><div class="CodeMirror-gutters" style="display: none; height: 154px;"></div></div></div></pre></blockquote><p>&nbsp;</p><p><strong><span>保存某个特殊的状态</span></strong><span>：在同一块画布中，有时候需要在某个步骤特殊处理时，需要设置一些新状态但又不想影响整体行为时，使用状态控制函数在状态栈中添加一个新的状态副本，在该副本中操作。该副本重新出栈后后序的操作将会使用之前的状态继续进行。</span></p><ul><li><p><span>CGContextSaveGState()：    拷贝一份当前状态的副本并压入状态栈中</span></p></li><li><p><span>CGContextRestoreGState(): 丢弃该副本（出栈）</span></p><blockquote><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="objective-c"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="objective-c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 某些时候，可能我们想要绘制黑色这一半时，不影响其他地方状态，我们可以拷贝一分当前状态到栈顶使用，</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 用完以后出战，这样就不会带来副作用，即某一部分特殊操作状态，但不影响外部整体状态</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">CGContextSaveGState</span>(<span class="cm-variable">ctx</span>); <span class="cm-comment">// 拷贝当前状态副本并push到栈顶</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 处理特殊部分，draw in here...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">CGContextRestoreGState</span>(<span class="cm-variable">ctx</span>); <span class="cm-comment">// 出栈状态副本</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// CGContextSaveGState与CGContextRestoreGState是一对cp</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 132px;"></div><div class="CodeMirror-gutters" style="display: none; height: 132px;"></div></div></div></pre></blockquote></li></ul><p>&nbsp;</p><p><strong><span>切换上下文</span></strong><span>：通常情况下，如果我们仅仅是想在某个上下文环境中保存某个状态，使用CGContextSaveGState即可，而如果是想让一个新的上下文成为当前绘制的上下文时，使用UIGraphicsPushContext。</span><a href='https://stackoverflow.com/questions/15505871/cgcontextsavegstate-vs-uigraphicspushcontext' target="_blank" rel="noopener"><span>stack overflow</span></a></p><p><span>我们在使用CoreGraphics的API进行绘图时，会使用UIGraphicsGetCurrentContext先获取到当前上下文环境context，因为CoreGraphics的API需要将当前的context作为参数。而在使用UIKit的API进行绘制时，UIKit的API通常不要求使用context作为参数，而是默认使用当前context（应用程序上下文栈顶的context），然而这可能会造成一个问题，那就是我们自己创建的context(CGContextCreate)获取到的context并不在当前应用程序的上下文环境栈中，此时UIKit的绘制任务所处的context可能并非我们设定的目标context，这可能会绘制失败或造成一定的异常。此时我们需要用到UIGraphicsPushContext和UIGraphicsPopContext函数,以保证UIKit获取到的context是我们设定的目标context。</span></p><blockquote><p><span>注意：UIGraphicsBeginImageContext 获取到的上下文默认已经设置为当前上下文，可以直接使用UIKit的API或者CoreGraphics的API进行绘图</span></p><p><span>UIKit的API： [image drawInRect:]，[color set], UIRectFill(rect)等，他们一个明显的标志是没有传入context参数</span></p></blockquote><hr /><blockquote><p><span>UIGraphicsPushContext()：压入某个新的context，并使之称为当前绘制上下文</span></p><p><span>UIGraphicsPopContext():     将某当前当前程序context栈的栈顶出栈，平衡上面的函数调用</span></p></blockquote><blockquote><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="objective-c"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="objective-c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// ---------- 指定ctx为当前操作的上下文，同时保证UIKit能在当前上下文绘制</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">UIGraphicsPushContext</span>(<span class="cm-variable">ctx</span>); <span class="cm-comment">// 入栈context，保证UIKit获取到的context是ctx</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 绘制一张纯色（橙色）图片到当前画布</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 使用UIKit方法进行绘制，只要使用UIKit的方法，都需要保证ctx在应用程序上下文环境栈顶</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[<span class="cm-variable">UIColor</span>.<span class="cm-variable">orangeColor</span> <span class="cm-variable">set</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">UIRectFill</span>(<span class="cm-variable">CGRectMake</span>(<span class="cm-number">0</span>, <span class="cm-number">0</span>, <span class="cm-number">50</span>, <span class="cm-number">50</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">UIGraphicsPopContext</span>(); <span class="cm-comment">// 出栈ctx</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// --------------------------------- 平衡调用，出栈ctx，状态回到之前</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// UIGraphicsPushContext和UIGraphicsPopContext是一对cp</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 220px;"></div><div class="CodeMirror-gutters" style="display: none; height: 220px;"></div></div></div></pre></blockquote><p>&nbsp;</p><h5><a name="32-示例" class="md-header-anchor"></a><span>3.2 示例</span></h5><p><span>一个常规的绘图流程包括如下，当然可以将绘制过程挪到异步线程以避免主线程阻塞，结果如下如所示</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="objective-c"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="objective-c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dispatch_async</span>(<span class="cm-variable">dispatch_get_global_queue</span>(<span class="cm-number">0</span>, <span class="cm-number">0</span>), <span class="cm-variable">^</span>{</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">UIGraphicsBeginImageContext</span>(<span class="cm-variable">CGSizeMake</span>(<span class="cm-number">100</span>, <span class="cm-number">100</span>)); <span class="cm-comment">// 创建一块位图画布</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">CGContextRef</span> <span class="cm-variable">ctx</span> <span class="cm-operator">=</span> <span class="cm-variable">UIGraphicsGetCurrentContext</span>(); &nbsp;<span class="cm-comment">// 获取当前画布</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 绘制一张纯色（橙色）图片到当前画布</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">CGContextSetFillColorWithColor</span>(<span class="cm-variable">ctx</span>, <span class="cm-variable">UIColor</span>.<span class="cm-variable">orangeColor</span>.<span class="cm-variable">CGColor</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">CGContextFillRect</span>(<span class="cm-variable">ctx</span>, <span class="cm-variable">CGRectMake</span>(<span class="cm-number">0</span>, <span class="cm-number">0</span>, <span class="cm-number">100</span>, <span class="cm-number">100</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">UIImage</span> <span class="cm-operator">*</span><span class="cm-variable">image</span> <span class="cm-operator">=</span> <span class="cm-variable">UIGraphicsGetImageFromCurrentImageContext</span>(); <span class="cm-comment">// 取得图片</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">UIGraphicsEndImageContext</span>(); <span class="cm-comment">// 销毁画布</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">dispatch_async</span>(<span class="cm-variable">dispatch_get_main_queue</span>(), <span class="cm-variable">^</span>{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">self</span>.<span class="cm-variable">imageView1</span>.<span class="cm-variable">image</span> <span class="cm-operator">=</span> <span class="cm-variable">image</span>; <span class="cm-comment">// 回到主线程设置图片到imageView</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">});</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 286px;"></div><div class="CodeMirror-gutters" style="display: none; height: 286px;"></div></div></div></pre><p><img src="./images/coregraphics1.png" referrerpolicy="no-referrer" alt="橙色图片"></p><p><span>有时候可能需要开发者自动手动维护一个状态栈，比如某些特殊需求，画一块 橙-黑-橙 组合颜色的图片，因为在画图是默认状态为橙色，但当画到中间是要变为黑色，此时可以增加一个状态副本，等完成了黑色绘制后销毁该副本，后续的操作继续使用之前的状态</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="objective-c" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="objective-c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">dispatch_async</span>(<span class="cm-variable">dispatch_get_global_queue</span>(<span class="cm-number">0</span>, <span class="cm-number">0</span>), <span class="cm-variable">^</span>{</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">UIGraphicsBeginImageContext</span>(<span class="cm-variable">CGSizeMake</span>(<span class="cm-number">100</span>, <span class="cm-number">100</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">CGContextRef</span> <span class="cm-variable">ctx</span> <span class="cm-operator">=</span> <span class="cm-variable">UIGraphicsGetCurrentContext</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 绘制 灰-黑-灰交替图片</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 这里设置当前状态栈顶的状态颜色为灰色</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">CGContextSetFillColorWithColor</span>(<span class="cm-variable">ctx</span>, <span class="cm-variable">UIColor</span>.<span class="cm-variable">orangeColor</span>.<span class="cm-variable">CGColor</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">CGContextFillRect</span>(<span class="cm-variable">ctx</span>, <span class="cm-variable">CGRectMake</span>(<span class="cm-number">0</span>, <span class="cm-number">0</span>, <span class="cm-number">30</span>, <span class="cm-number">100</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 某些时候，可能我们想要绘制黑色这一半时，不影响其他地方状态，我们可以拷贝一分当前状态到栈顶使用，</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 用完以后出战，这样就不会带来副作用，即某一部分特殊操作状态，但不影响外部整体状态</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">CGContextSaveGState</span>(<span class="cm-variable">ctx</span>); <span class="cm-comment">// 拷贝当前状态副本并push到栈顶</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 处理特殊部分</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">CGContextSetFillColorWithColor</span>(<span class="cm-variable">ctx</span>, <span class="cm-variable">UIColor</span>.<span class="cm-variable">blackColor</span>.<span class="cm-variable">CGColor</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">CGContextFillRect</span>(<span class="cm-variable">ctx</span>, <span class="cm-variable">CGRectMake</span>(<span class="cm-number">30</span>, <span class="cm-number">0</span>, <span class="cm-number">40</span>, <span class="cm-number">100</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">CGContextRestoreGState</span>(<span class="cm-variable">ctx</span>); <span class="cm-comment">// 出栈状态副本</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 这里仍然使用之前的状态，中途黑色状态栈是副本，已经出栈，这里使用到的依然是之前灰色状态</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">CGContextFillRect</span>(<span class="cm-variable">ctx</span>, <span class="cm-variable">CGRectMake</span>(<span class="cm-number">70</span>, <span class="cm-number">0</span>, <span class="cm-number">30</span>, <span class="cm-number">100</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">UIImage</span> <span class="cm-operator">*</span><span class="cm-variable">image</span> <span class="cm-operator">=</span> <span class="cm-variable">UIGraphicsGetImageFromCurrentImageContext</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">UIGraphicsEndImageContext</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">dispatch_async</span>(<span class="cm-variable">dispatch_get_main_queue</span>(), <span class="cm-variable">^</span>{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">self</span>.<span class="cm-variable">imageView1</span>.<span class="cm-variable">image</span> <span class="cm-operator">=</span> <span class="cm-variable">image</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  });</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  });</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 572px;"></div><div class="CodeMirror-gutters" style="display: none; height: 572px;"></div></div></div></pre><p><img src="./images/coregraphics2.png" referrerpolicy="no-referrer" alt="灰-黑-灰交替图片"></p><p><span>有时候获取到的context不是当前上下文，需要使用UIGraphicsPushContext指定为当前绘制上下文context</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="objective-c" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="objective-c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">@interface</span> <span class="cm-variable">CustomView</span> : <span class="cm-variable">UIView</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">@end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">@implementation</span> <span class="cm-variable">CustomView</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">-</span> (<span class="cm-variable-3">void</span>)<span class="cm-variable">drawRect</span>:(<span class="cm-variable">CGRect</span>)<span class="cm-variable">rect</span> {</span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// draw in here...</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">// 这里无需UIGraphicsPushContext，默认就是在当前context环境下</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// setNeedsDisplay触发调用</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">-</span> (<span class="cm-variable-3">void</span>)<span class="cm-variable">drawLayer</span>:(<span class="cm-variable">CALayer</span> <span class="cm-operator">*</span>)<span class="cm-variable">layer</span> <span class="cm-variable">inContext</span>:(<span class="cm-variable">CGContextRef</span>)<span class="cm-variable">ctx</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// ---------- 指定ctx为当前操作的上下文，同时保证UIKit能在当前上下文绘制</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">UIGraphicsPushContext</span>(<span class="cm-variable">ctx</span>); <span class="cm-comment">// 入栈context，保证UIKit获取到的context是ctx</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 绘制一张纯色（橙色）图片到当前画布</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 使用UIKit方法进行绘制，只要使用UIKit的方法，都需要保证ctx在应用程序上下文环境栈顶</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  [<span class="cm-variable">UIColor</span>.<span class="cm-variable">orangeColor</span> <span class="cm-variable">set</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">UIRectFill</span>(<span class="cm-variable">CGRectMake</span>(<span class="cm-number">0</span>, <span class="cm-number">0</span>, <span class="cm-number">50</span>, <span class="cm-number">50</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">UIGraphicsPopContext</span>(); <span class="cm-comment">// 出栈ctx</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// --------------------------------- 平衡调用，出栈ctx，状态回到之前</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">@end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// UIGraphicsPushContext和UIGraphicsPopContext是一对cp</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 462px;"></div><div class="CodeMirror-gutters" style="display: none; height: 462px;"></div></div></div></pre><p>&nbsp;</p><h5><a name="33-总结" class="md-header-anchor"></a><span>3.3 总结</span></h5><p><span>这里对上问的思路进行整理，方便理解</span></p><p><strong><span>1）如果在drawRect方法中</span></strong><span>：可以直接使用UIKit的API或者CoreGraphics的API进行绘制</span></p><p><strong><span>2）使用UIGraphicsBeginImageContext时</span></strong><span>：可以直接使用UIKit的API或者CoreGraphics的API进行绘制</span></p><p><strong><span>3）其它情况下</span></strong><span>：当你持有context参数可以直接使用CoreGraphics的API，或者通过UIGraphicsPushContext将context指定为当前context以支持UIKit的API</span></p><p><strong><span>4）两个函数区分</span></strong><span>：如果我们仅仅是想在某个上下文环境中保存某个状态，使用CGContextSaveGState即可，而如果是想让一个新的上下文成为当前绘制的上下文时，使用UIGraphicsPushContext</span></p><p><strong><span>5）堆栈平衡CP</span></strong><span>：别忘记beginContext--&gt;endContext, saveGState--&gt;RestoreGState, pushContext--&gt;popContext</span></p><p>&nbsp;</p><h3><a name="3-图片使用技巧" class="md-header-anchor"></a><span>3. 图片使用技巧</span></h3><p><span>由于CoreGraphics线程安全，因此我们可以使用CoreGraphics框架异步处理图片，在UIKit框架中，图片处理过程通常是在主线程中进行，这是最简单的一种方式，什么都交给UIKit来处理，不过存在的一个问题就是当图片处理过程过于复杂时，可能会导致UI卡顿（即掉帧）。比如，我们将图片交给UIKit的UIImageView处理，它会在第一次显示图片时对图片进行解码，解码到位图数据后再交给OpenGL(新版本Metal)渲染，由于这个过程在主线程进行，如果当图片过大或者一次性解码的图片过多时，会导致屏幕丢帧，造成视觉上的卡顿。</span></p><p><span>一些比较知名的第三方库（</span><a href='https://github.com/SDWebImage/SDWebImage' target="_blank" rel="noopener"><span>SDWebImage</span></a><span>、</span><a href='https://github.com/ibireme/YYWebImage' target="_blank" rel="noopener"><span>YYWebImage</span></a><span>等）的实现方式则是将图片的解码过程提前，即图片下载完成后先在异步线程中解码好，然后将解码后的图片给到UIImageView，等到UIImageView需要显示时直接获取到的是解码后的位图数据，省去了主线程中解码的过程，带来更流畅的UI效果。</span></p><p><span>参照该思路，我们我们还可以将除了图片解码外的操作放到异步线程中去，给主主线程分担更多工作任务，这其中能够提前放到异步线程处理的图片操作有一下这些：尺寸调整、圆角、滤镜、颜色混合等效果。</span></p><p><span>SDWebImage新版接口提供了一个SDWebImageContext参数，该参数是一个字典，可以将图片变换等相关操作使用命令对象的方式传入，稍后SDWebImage会在图片下载完成后读取该字典中的变换对象，在异步线程中做响应的变换。</span></p><h5><a name="31-异步调整尺寸裁剪）基于sdwebimage" class="md-header-anchor"></a><span>3.1 异步调整尺寸（裁剪），基于SDWebImage</span></h5><p><span>如果提前将图片按照我们要显示的UIImageView的大小调整好，当UIKit显示该图片的时候就省去了图片裁剪过程，以下为图片尺寸裁剪的关键步骤，它执行在异步线程</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="objective-c"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="objective-c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">@interface</span> <span class="cm-variable">SDImageResizingTransformer</span> : <span class="cm-variable">NSObject</span> <span class="cm-operator">&lt;</span><span class="cm-variable">SDImageTransformer</span><span class="cm-operator">&gt;</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">@property</span> (<span class="cm-keyword">nonatomic</span>, <span class="cm-variable">assign</span>, <span class="cm-keyword">readonly</span>) <span class="cm-variable">CGSize</span> <span class="cm-variable">size</span>; <span class="cm-comment">// 目标尺寸</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">@property</span> (<span class="cm-keyword">nonatomic</span>, <span class="cm-variable">assign</span>, <span class="cm-keyword">readonly</span>) <span class="cm-variable">SDImageScaleMode</span> <span class="cm-variable">scaleMode</span>; <span class="cm-comment">// 图片缩放模式</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">@end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 调整图片尺寸 --------------------------</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">SDImageResizingTransformer</span> <span class="cm-operator">*</span><span class="cm-variable">tesizingTransformer</span> <span class="cm-operator">=</span> [<span class="cm-variable">SDImageResizingTransformer</span> <span class="cm-variable">transformerWithSize</span>:<span class="cm-variable">targetSize</span> <span class="cm-variable">scaleMode</span>:<span class="cm-variable">SDImageScaleModeAspectFill</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">context</span>[<span class="cm-variable">SDWebImageContextImageTransformer</span>] <span class="cm-operator">=</span> <span class="cm-variable">tesizingTransformer</span>; <span class="cm-comment">// 传给SDWebImage</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 调整图片尺寸 --------------------------</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 198px;"></div><div class="CodeMirror-gutters" style="display: none; height: 198px;"></div></div></div></pre><h5><a name="32-异步设置圆角基于sdwebimage" class="md-header-anchor"></a><span>3.2 异步设置圆角，基于SDWebImage</span></h5><p><span>如果图片UIImageView存在圆角，UIKit显示的时候可能会发生</span><code>离屏渲染</code><span>，离屏渲染代价比较高，需要开辟新的屏幕缓冲区以及渲染上下文切换的操作，如果我们可以将图片圆角操作提前做好，不经可以免去UIKit圆角计算操作，还能避免高代价的离屏渲染，SDWebImage中，实现圆角的Transformer类为SDImageRoundCornerTransformer</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="objective-c"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="objective-c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">@interface</span> <span class="cm-variable">SDImageRoundCornerTransformer</span> : <span class="cm-variable">NSObject</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">@property</span> (<span class="cm-keyword">nonatomic</span>, <span class="cm-variable">assign</span>) <span class="cm-variable">CGFloat</span> <span class="cm-variable">cornerRadius</span>; <span class="cm-comment">// 圆角半径</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">@property</span> (<span class="cm-keyword">nonatomic</span>, <span class="cm-variable">assign</span>) <span class="cm-variable">UIRectCorner</span> <span class="cm-variable">corners</span>; <span class="cm-comment">// 圆角位置</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">@property</span> (<span class="cm-keyword">nonatomic</span>, <span class="cm-variable">assign</span>) <span class="cm-variable">CGFloat</span> <span class="cm-variable">borderWidth</span>; &nbsp;<span class="cm-comment">// 边框宽度</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">@property</span> (<span class="cm-keyword">nonatomic</span>, <span class="cm-variable">strong</span>, <span class="cm-variable">nullable</span>) <span class="cm-variable">UIColor</span> <span class="cm-operator">*</span><span class="cm-variable">borderColor</span>; <span class="cm-comment">// 边框颜色</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">@end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 图片圆角 --------------------------</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">SDImageRoundCornerTransformer</span> <span class="cm-operator">*</span><span class="cm-variable">roundCornerTransformer</span> <span class="cm-operator">=</span> ...</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">context</span>[<span class="cm-variable">SDWebImageContextImageTransformer</span>] <span class="cm-operator">=</span> <span class="cm-variable">roundCornerTransformer</span>; <span class="cm-comment">// 传给SDWebImage</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 图片圆角 --------------------------</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 220px;"></div><div class="CodeMirror-gutters" style="display: none; height: 220px;"></div></div></div></pre><p><span>当然我们还可以将多个效果放入一个处理管道，实现多种效果的叠加</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="objective-c"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="objective-c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">NSMutableArray</span><span class="cm-operator">&lt;</span><span class="cm-keyword">id</span><span class="cm-operator">&lt;</span><span class="cm-variable">SDImageTransformer</span><span class="cm-operator">&gt;&gt;</span> <span class="cm-operator">*</span><span class="cm-variable">transformers</span> <span class="cm-operator">=</span> <span class="cm-keyword">@</span>[].<span class="cm-variable">mutableCopy</span>;</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 调整图片尺寸 --------------------------</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">SDImageResizingTransformer</span> <span class="cm-operator">*</span><span class="cm-variable">tesizingTransformer</span> <span class="cm-operator">=</span> ...</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[<span class="cm-variable">transformers</span> <span class="cm-variable">addObject</span>:<span class="cm-variable">tesizingTransformer</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 图片圆角 --------------------------</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">SDImageRoundCornerTransformer</span> <span class="cm-operator">*</span><span class="cm-variable">roundCornerTransformer</span> <span class="cm-operator">=</span> ...</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[<span class="cm-variable">transformers</span> <span class="cm-variable">addObject</span>:<span class="cm-variable">roundCornerTransformer</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 处理管道</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">SDImagePipelineTransformer</span> <span class="cm-operator">*</span><span class="cm-variable">pipelineTransformer</span> <span class="cm-operator">=</span> [<span class="cm-variable">SDImagePipelineTransformer</span> <span class="cm-variable">transformerWithTransformers</span>:<span class="cm-variable">transformers</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 传给SDWebImage</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">context</span>[<span class="cm-variable">SDWebImageContextImageTransformer</span>] <span class="cm-operator">=</span> <span class="cm-variable">pipelineTransformer</span>; </span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 308px;"></div><div class="CodeMirror-gutters" style="display: none; height: 308px;"></div></div></div></pre><h5><a name="33-超大图分块解码基于sdwebimage" class="md-header-anchor"></a><span>3.3 超大图分块解码，基于SDWebImage</span></h5><p><span>超大图解码一般在SDWebImage5.0以前，需要手动实现大图分块解码的算法过程，不过SDWebImage5.0之后提供了该功能，实现该功能只需添加一个SD选项即可：</span><code>SDWebImageScaleDownLargeImages</code></p><p><span>如果项目中图分辨率不操过4096 * 4096时，问题不是很大，但如果项目中出现超过这个分辨率的图片时，可能会导致部分iPhone机型由于内存占用过高而闪退，通常情况下，在SD的选项中建议传入该参数</span><code>SDWebImageScaleDownLargeImages</code><span>避免某些可能的异常行为</span></p><p>&nbsp;</p><h3><a name="4界面流程性能优化技巧" class="md-header-anchor"></a><span>4.界面流程性能优化技巧</span></h3><h5><a name="41-避免离屏渲染" class="md-header-anchor"></a><span>4.1 避免离屏渲染</span></h5><h5><a name="42-复杂计算异步线程处理如frame等）" class="md-header-anchor"></a><span>4.2 复杂计算异步线程处理（如frame等）</span></h5><h5><a name="43-避免自动布局xib" class="md-header-anchor"></a><span>4.3 避免自动布局、XIB</span></h5><p>&nbsp;</p><p>&nbsp;</p><h1><a name="ios架构和重要组件" class="md-header-anchor"></a><span>iOS架构和重要组件</span></h1><h3><a name="1-组件化架构" class="md-header-anchor"></a><span>1. 组件化架构</span></h3><p><span>客户端组件化架构，类似于服务端目前比较流行的微服务架构，其实现的一个总体思路是将整个项目拆分为多个子项目，提供一个消息中间件Mediator，多个子项目之间发送消息统一由这个Mediator处理，这样每个业务组件专注于自身业务，不予其他业务组件耦合，同时容易实现“接头”功能，方便动态地新增或者屏蔽某些功能组件，下面是一个组件化架构的一个基本思路图，实际上它就是设计模式中常常提到的中介者模式</span></p><p><span>这里有一个系列</span><a href='https://casatwy.com/iosying-yong-jia-gou-tan-kai-pian.html' target="_blank" rel="noopener"><span>文章</span></a><span>，casa当时工作在安居客，从事架构设计工作</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="c" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-operator">--------------</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">--------------</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">--------------</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-operator">|</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">|</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">|</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">|</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">|</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">|</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-operator">|</span> <span class="cm-variable">Buisness</span> <span class="cm-variable">A</span> <span class="cm-operator">|</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">|</span> <span class="cm-variable">Buisness</span> <span class="cm-variable">B</span> <span class="cm-operator">|</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">|</span> <span class="cm-variable">Buisness</span> <span class="cm-variable">C</span> <span class="cm-operator">|</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-operator">|</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">|</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">|</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">|</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">|</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">|</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-operator">--------------</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">--------------</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">--------------</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">\</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">|</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">\</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">|</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">\</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">|</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">/</span> &nbsp;<span class="cm-variable">通过Mediater来召唤页面</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">\</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">|</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">\</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">|</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">--------------------------------</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">|</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">|</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">|</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Mediater</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">|</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">|</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">|</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">--------------------------------</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">|</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">|</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">|</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">|</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">|</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">--------------------------------</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">|</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">|</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">|</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">App</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">|</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">|</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">|</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">--------------------------------</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 550px;"></div><div class="CodeMirror-gutters" style="display: none; height: 550px;"></div></div></div></pre><p>&nbsp;</p><h3><a name="2网络请求组件-afnetworkinghttpsgithubcomafnetworkingafnetworking" class="md-header-anchor"></a><span>2.网络请求组件 </span><a href='https://github.com/AFNetworking/AFNetworking' target="_blank" rel="noopener"><span>AFNetworking</span></a></h3><blockquote><p><a href='https://juejin.im/entry/589d1aa161ff4b006b37408e' target="_blank" rel="noopener"><span>IOS 网络请求之 AFNetWorking 3.x 使用</span></a></p><p><a href='https://www.jianshu.com/p/0dd08712c649' target="_blank" rel="noopener"><span>iOS-网络编程(一)HTTP协议</span></a><span>、</span><a href='https://www.jianshu.com/p/78964aac72d5' target="_blank" rel="noopener"><span>iOS-网络编程(二)文件上传和断点离线下载</span></a><span> 、</span><a href='https://www.jianshu.com/p/d94cb6b58573' target="_blank" rel="noopener"><span>iOS-网络编程(三)AFNetworking使用</span></a></p></blockquote><h3><a name="3图片加载组件-sdwebimagehttpsgithubcomsdwebimagesdwebimage" class="md-header-anchor"></a><span>3.图片加载组件 </span><a href='https://github.com/SDWebImage/SDWebImage' target="_blank" rel="noopener"><span>SDWebImage</span></a></h3><blockquote><p><a href='https://blog.csdn.net/qq_16146389/article/details/88355852' target="_blank" rel="noopener"><span>SDWebImage的使用和底层原理</span></a></p><p><a href='https://juejin.im/post/5c04fb8de51d451b4513acf9' target="_blank" rel="noopener"><span>SDWebImage中文说明</span></a></p></blockquote><h3><a name="4json转model组件-mjextensionhttpsgithubcomcodermjleemjextension" class="md-header-anchor"></a><span>4.JSON转Model组件 </span><a href='https://github.com/CoderMJLee/MJExtension' target="_blank" rel="noopener"><span>MJExtension</span></a></h3><blockquote><p><a href='[https://github.com/CoderMJLee/MJExtension#-examples%E7%A4%BA%E4%BE%8B](https://github.com/CoderMJLee/MJExtension#-examples示例)'><span>官方示例文档 - 中文</span></a></p><p><a href='https://www.cnblogs.com/mjios/category/1526581.html' target="_blank" rel="noopener"><span>KakaJSON手册- swift版</span></a></p></blockquote><h3><a name="5数据库管理组件-fmdbhttpsgithubcomccgusfmdb一个ios版的jdbc实现" class="md-header-anchor"></a><span>5.数据库管理组件 </span><a href='https://github.com/ccgus/fmdb' target="_blank" rel="noopener"><span>fmdb</span></a><span>(一个iOS版的JDBC实现)</span></h3><blockquote><p><a href='https://www.jianshu.com/p/6a2cc1ad18da' target="_blank" rel="noopener"><span>iOS数据库之FMDB的使用</span></a></p><p><a href='[https://lishibo-ios.github.io/2018/09/21/FMDB%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/](https://lishibo-ios.github.io/2018/09/21/FMDB的基本使用/)'><span>FMDB的基本使用</span></a></p></blockquote><h3><a name="6自动布局组件-masonryhttpsgithubcomsnapkitmasonry" class="md-header-anchor"></a><span>6.自动布局组件 </span><a href='https://github.com/SnapKit/Masonry' target="_blank" rel="noopener"><span>Masonry</span></a></h3><blockquote><p><a href='https://www.jianshu.com/p/fba79bcc10e1' target="_blank" rel="noopener"><span>masonry 使用笔记</span></a><span>  </span><a href='https://juejin.im/post/5ac34f9351882555867f9f12' target="_blank" rel="noopener"><span>Masonry 使用</span></a></p></blockquote><h3><a name="7下拉刷新组件mjrefreshhttpsgithubcomcodermjleemjrefresh" class="md-header-anchor"></a><span>7.下拉刷新组件</span><a href='https://github.com/CoderMJLee/MJRefresh' target="_blank" rel="noopener"><span>MJRefresh</span></a></h3><blockquote><p><a href='https://juejin.im/post/5a311bc35188254dd936662f' target="_blank" rel="noopener"><span>iOS 刷新控件MJrefresh的基本使用</span></a></p><p><a href='https://juejin.im/post/5a7914765188257a6c68eab8' target="_blank" rel="noopener"><span>MJRefresh源码剖析与学习</span></a></p></blockquote><h3><a name="8其他组件-ios开源聚合httpszouzzprogrammerwordpresscom20160722ios开源" class="md-header-anchor"></a><span>8.其他组件 </span><a href='https://zouzzprogrammer.wordpress.com/2016/07/22/ios开源/' target="_blank" rel="noopener"><span>iOS开源聚合</span></a><span> </span></h3><p>&nbsp;</p></div>
</body>
</html>
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/02/13/hello-world/" rel="prev" title="Hello World">
                Hello World <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/uploads/avatar.jpeg"
                alt="nius" />
            
              <p class="site-author-name" itemprop="name">nius</p>
              <p class="site-description motion-element" itemprop="description">A loser, or not.</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/zengweijun" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.jianshu.com/u/d8ab62002fe9" target="_blank" title="简书">
                      
                        <i class="fa fa-fw fa-link"></i>简书</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#write"><span class="nav-number">1.</span> <span class="nav-text">Objective-C 语言</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#write"><span class="nav-number">1.0.1.</span> <span class="nav-text">1. Objective-C简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#write"><span class="nav-number">1.0.2.</span> <span class="nav-text">2.认识NSObject</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#write"><span class="nav-number">1.0.3.</span> <span class="nav-text">3.内存管理</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#write"><span class="nav-number">1.0.3.0.1.</span> <span class="nav-text">3.1 关于MRC（手动引用计数）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#write"><span class="nav-number">1.0.3.0.2.</span> <span class="nav-text">3.2 关于ARC（自动引用计数）</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#write"><span class="nav-number">1.0.4.</span> <span class="nav-text">4.认识Block</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#write"><span class="nav-number">1.0.4.0.1.</span> <span class="nav-text">4.1 block类</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#write"><span class="nav-number">1.0.4.0.2.</span> <span class="nav-text">4.2 block的内存管理</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#write"><span class="nav-number">1.0.4.0.3.</span> <span class="nav-text">4.3 __bock修饰的变量</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#write"><span class="nav-number">1.0.4.0.4.</span> <span class="nav-text">4.4 破除循环引用的三种方式</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#write"><span class="nav-number">1.0.5.</span> <span class="nav-text">5.runtime（消息机制）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#write"><span class="nav-number">1.0.6.</span> <span class="nav-text">6.NSRunLoop（运行循环）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#write"><span class="nav-number">1.0.7.</span> <span class="nav-text">7.多线程</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#write"><span class="nav-number">1.0.7.0.1.</span> <span class="nav-text">7.1 GCD</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#write"><span class="nav-number">1.0.7.0.2.</span> <span class="nav-text">7.1 常用函数说明</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#write"><span class="nav-number">1.0.7.0.3.</span> <span class="nav-text">7.2 常用队列</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#write"><span class="nav-number">1.0.7.0.3.1.</span> <span class="nav-text">7.2.1 串行队列</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#write"><span class="nav-number">1.0.7.0.3.2.</span> <span class="nav-text">7.2.2 并发队列</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#write"><span class="nav-number">1.0.7.0.4.</span> <span class="nav-text">7.3 队列的挂起和恢复</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#write"><span class="nav-number">1.0.7.0.5.</span> <span class="nav-text">7.4 dispath_group_t</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#write"><span class="nav-number">1.0.7.0.6.</span> <span class="nav-text">7.5 栅栏函数 dispath_barrier_async</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#write"><span class="nav-number">1.0.7.0.7.</span> <span class="nav-text">5.6 dispath_apply函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#write"><span class="nav-number">1.0.7.0.8.</span> <span class="nav-text">7.7 dispath_semaphore_t</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#write"><span class="nav-number">1.0.7.0.9.</span> <span class="nav-text">7.8 dispath_io</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#write"><span class="nav-number">1.0.7.0.10.</span> <span class="nav-text">7.9 其他多线程技术包括NSThread、NSOperation、pthread</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#write"><span class="nav-number">1.0.8.</span> <span class="nav-text">8. 锁的使用</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#write"><span class="nav-number">2.</span> <span class="nav-text">UI高级</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#write"><span class="nav-number">2.0.1.</span> <span class="nav-text">1. UIKit架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#write"><span class="nav-number">2.0.2.</span> <span class="nav-text">2. 设置UIView圆角</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#write"><span class="nav-number">2.0.2.0.1.</span> <span class="nav-text">2.1 圆角实现原理</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#write"><span class="nav-number">2.0.2.0.2.</span> <span class="nav-text">2.2 解决疑问</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#write"><span class="nav-number">2.0.3.</span> <span class="nav-text">3. CoreGraphics(基于QuartZ 2D)  CoreGrpaphics</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#write"><span class="nav-number">2.0.3.0.1.</span> <span class="nav-text">3.1 部分函数说明</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#write"><span class="nav-number">2.0.3.0.2.</span> <span class="nav-text">3.2 示例</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#write"><span class="nav-number">2.0.3.0.3.</span> <span class="nav-text">3.3 总结</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#write"><span class="nav-number">2.0.4.</span> <span class="nav-text">3. 图片使用技巧</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#write"><span class="nav-number">2.0.4.0.1.</span> <span class="nav-text">3.1 异步调整尺寸（裁剪），基于SDWebImage</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#write"><span class="nav-number">2.0.4.0.2.</span> <span class="nav-text">3.2 异步设置圆角，基于SDWebImage</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#write"><span class="nav-number">2.0.4.0.3.</span> <span class="nav-text">3.3 超大图分块解码，基于SDWebImage</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#write"><span class="nav-number">2.0.5.</span> <span class="nav-text">4.界面流程性能优化技巧</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#write"><span class="nav-number">2.0.5.0.1.</span> <span class="nav-text">4.1 避免离屏渲染</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#write"><span class="nav-number">2.0.5.0.2.</span> <span class="nav-text">4.2 复杂计算异步线程处理（如frame等）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#write"><span class="nav-number">2.0.5.0.3.</span> <span class="nav-text">4.3 避免自动布局、XIB</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#write"><span class="nav-number">3.</span> <span class="nav-text">iOS架构和重要组件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#write"><span class="nav-number">3.0.1.</span> <span class="nav-text">1. 组件化架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#write"><span class="nav-number">3.0.2.</span> <span class="nav-text">2.网络请求组件 AFNetworking</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#write"><span class="nav-number">3.0.3.</span> <span class="nav-text">3.图片加载组件 SDWebImage</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#write"><span class="nav-number">3.0.4.</span> <span class="nav-text">4.JSON转Model组件 MJExtension</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#write"><span class="nav-number">3.0.5.</span> <span class="nav-text">5.数据库管理组件 fmdb(一个iOS版的JDBC实现)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#write"><span class="nav-number">3.0.6.</span> <span class="nav-text">6.自动布局组件 Masonry</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#write"><span class="nav-number">3.0.7.</span> <span class="nav-text">7.下拉刷新组件MJRefresh</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#write"><span class="nav-number">3.0.8.</span> <span class="nav-text">8.其他组件 iOS开源聚合 </span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">nius</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'wBRl1pbRkdYYLxN4iRrfDT6h-gzGzoHsz',
        appKey: '3Hv5gfmWF6bs0mfgclJ51Ecb',
        placeholder: 'Just go go',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  





  

  

  

  
  

  

  

  

</body>
</html>
